# WhatsApp Business API - Documentaci√≥n

## Configuraci√≥n

### Variables de Entorno (.env)

```env
# WhatsApp Business API Configuration
WHATSAPP_ACCESS_TOKEN=tu_access_token_de_whatsapp
WHATSAPP_PHONE_NUMBER_ID=tu_phone_number_id
WHATSAPP_BUSINESS_ACCOUNT_ID=tu_business_account_id
WHATSAPP_VERIFY_TOKEN=tu_verify_token_secreto
WHATSAPP_API_VERSION=v21.0

# Redis Configuration (Requerido para autenticaci√≥n de WhatsApp)
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=
REDIS_DECODE_RESPONSES=true
```

### Obtener Phone Number ID

1. Ve a https://developers.facebook.com/
2. Selecciona tu aplicaci√≥n de WhatsApp Business
3. Ve a "WhatsApp" > "Configuraci√≥n de API"
4. Copia el "Phone Number ID"

## Arquitectura de Autenticaci√≥n

### Documentaci√≥n Completa

Para entender el sistema completo de autenticaci√≥n unificado (Web, WhatsApp y Microsoft OAuth), consulta:

üìÑ **[Sistema Unificado de Autenticaci√≥n](./auth_service.md)**

Este documento incluye:
- Arquitectura de sesiones en Redis
- Flujos de autenticaci√≥n para Web y WhatsApp
- Integraci√≥n con Microsoft OAuth
- Stored Procedures de asociaci√≥n de cuentas
- Ejemplos de testing completos

### Componentes

1. **`app/core/redis.py`**: Cliente Redis gen√©rico y reutilizable para toda la aplicaci√≥n
2. **`app/services/whatsapp_service.py`**: Servicio completo de WhatsApp incluyendo mensajer√≠a y autenticaci√≥n
3. **`app/api/routes/whatsapp.py`**: Todos los endpoints de WhatsApp (webhook, env√≠o, autenticaci√≥n)

### Flujo de Autenticaci√≥n

1. Usuario env√≠a mensaje por WhatsApp ‚Üí Sistema verifica autenticaci√≥n
2. Si NO est√° autenticado: 
   - Sistema genera token √∫nico (v√°lido 5 minutos)
   - Env√≠a link de autenticaci√≥n por WhatsApp
3. Usuario hace clic en link ‚Üí P√°gina HTML con auto-redirect a Microsoft OAuth
4. Usuario se autentica con Microsoft
5. Callback guarda datos en Redis (v√°lido 24 horas)
6. Usuario puede usar el bot sin restricciones

## Endpoints Disponibles

### 1. Verificaci√≥n del Webhook (GET)

**Endpoint:** `GET /api/whatsapp/webhook`

Meta llama a este endpoint para verificar tu webhook.

**Par√°metros:**
- `hub.mode`: "subscribe"
- `hub.verify_token`: Token configurado en .env
- `hub.challenge`: Cadena a retornar

**Configuraci√≥n en Meta:**
1. Ve a tu app en Meta for Developers
2. WhatsApp > Configuraci√≥n
3. Callback URL: `https://tu-dominio.com/api/whatsapp/webhook`
4. Verify Token: `tu_verify_token_secreto` (el mismo que configuraste en .env)
5. Suscr√≠bete a los eventos: `messages`

### 2. Recibir Webhooks (POST)

**Endpoint:** `POST /api/whatsapp/webhook`

Meta env√≠a notificaciones aqu√≠ cuando ocurren eventos.

**Sin autenticaci√≥n requerida** (Meta env√≠a directamente)

**Funcionalidad implementada:**
- ‚úÖ Verifica autenticaci√≥n del usuario antes de procesar
- ‚úÖ Env√≠a link de autenticaci√≥n si no est√° autenticado
- ‚úÖ Marca mensajes como le√≠dos autom√°ticamente (doble check azul)
- ‚úÖ Procesa mensajes de texto con IA
- ‚úÖ Procesa im√°genes con an√°lisis visual
- ‚úÖ Transcribe y procesa mensajes de audio
- ‚úÖ Responde autom√°ticamente con GPT-5
- ‚úÖ Mantiene historial de conversaci√≥n por usuario

### 3. Estado del Servicio (GET)

**Endpoint:** `GET /api/whatsapp/status`

**Sin autenticaci√≥n requerida**

Verifica la configuraci√≥n del servicio de WhatsApp.

**Respuesta:**
```json
{
  "service": "WhatsApp Business API",
  "configured": true,
  "api_version": "v21.0",
  "phone_number_id_set": true,
  "access_token_set": true,
  "supported_message_types": [
    "text",
    "image",
    "video",
    "document",
    "audio",
    "location",
    "contacts",
    "template",
    "interactive"
  ],
  "webhook_configured": true,
  "features": {
    "receive_messages": true,
    "send_messages": true,
    "validate_signature": false
  }
}
```

### 4. Enviar Mensaje (POST)

**Endpoint:** `POST /api/whatsapp/send`

**üîí Requiere autenticaci√≥n JWT**

Env√≠a cualquier tipo de mensaje de WhatsApp.

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Body (Texto simple):**
```json
{
  "to": "5491112345678",
  "type": "text",
  "text": {
    "body": "Hola, este es un mensaje de prueba"
  }
}
```

**Body (Imagen con URL):**
```json
{
  "to": "5491112345678",
  "type": "image",
  "image": {
    "link": "https://ejemplo.com/imagen.jpg",
    "caption": "Mira esta imagen"
  }
}
```

**Body (Mensaje interactivo con botones):**
```json
{
  "to": "5491112345678",
  "type": "interactive",
  "interactive": {
    "type": "button",
    "body": {
      "text": "¬øQu√© deseas hacer?"
    },
    "action": {
      "buttons": [
        {
          "type": "reply",
          "reply": {
            "id": "btn1",
            "title": "Ver productos"
          }
        },
        {
          "type": "reply",
          "reply": {
            "id": "btn2",
            "title": "Soporte"
          }
        }
      ]
    }
  }
}
```

### 5. Enviar Texto Simple (POST)

**Endpoint:** `POST /api/whatsapp/send/text`

**üîí Requiere autenticaci√≥n JWT**

Endpoint simplificado para enviar solo texto.

**Query Parameters:**
- `to`: N√∫mero de tel√©fono (ej: "5491112345678")
- `message`: Contenido del mensaje
- `preview_url`: true/false (opcional, default: false)

**Ejemplo:**
```
POST /api/whatsapp/send/text?to=5491112345678&message=Hola%20mundo
```

### 6. Enviar Imagen (POST)

**Endpoint:** `POST /api/whatsapp/send/image`

**üîí Requiere autenticaci√≥n JWT**

**Query Parameters:**
- `to`: N√∫mero de tel√©fono
- `image_url`: URL p√∫blica de la imagen (opcional)
- `image_id`: ID de imagen subida (opcional)
- `caption`: Texto descriptivo (opcional)

### 7. Enviar Documento (POST)

**Endpoint:** `POST /api/whatsapp/send/document`

**üîí Requiere autenticaci√≥n JWT**

**Query Parameters:**
- `to`: N√∫mero de tel√©fono
- `document_url`: URL p√∫blica del documento
- `filename`: Nombre del archivo (opcional)
- `caption`: Texto descriptivo (opcional)

### 8. Enviar Ubicaci√≥n (POST)

**Endpoint:** `POST /api/whatsapp/send/location`

**üîí Requiere autenticaci√≥n JWT**

**Query Parameters:**
- `to`: N√∫mero de tel√©fono
- `latitude`: Latitud
- `longitude`: Longitud
- `name`: Nombre del lugar (opcional)
- `address`: Direcci√≥n (opcional)

### 9. Enviar Plantilla (POST)

**Endpoint:** `POST /api/whatsapp/send/template`

**üîí Requiere autenticaci√≥n JWT**

**Query Parameters:**
- `to`: N√∫mero de tel√©fono
- `template_name`: Nombre de la plantilla aprobada
- `language_code`: C√≥digo de idioma (default: "es")

### 10. Solicitar Token de Autenticaci√≥n (POST)

**Endpoint:** `POST /api/whatsapp/auth/request-token`

**Sin autenticaci√≥n requerida**

Genera un token √∫nico para que un usuario de WhatsApp se autentique con Microsoft.

**Body:**
```json
{
  "phone_number": "5491112345678"
}
```

**Respuesta:**
```json
{
  "success": true,
  "token": "token_generado_aqui",
  "auth_url": "https://tu-dominio.com/api/whatsapp/auth/page?token=...",
  "message": "Token generado exitosamente. V√°lido por 5 minutos."
}
```

### 11. Verificar Estado de Autenticaci√≥n (GET)

**Endpoint:** `GET /api/whatsapp/auth/status?phone_number=5491112345678`

**Sin autenticaci√≥n requerida**

Verifica si un usuario de WhatsApp est√° autenticado.

**Respuesta (autenticado):**
```json
{
  "authenticated": true,
  "phone_number": "5491112345678",
  "user_data": {
    "codeLogin": 123,
    "email": "usuario@ejemplo.com",
    "name": "Juan P√©rez",
    "authenticated_at": "2025-10-20T10:30:00",
    "expires_at": "2025-10-21T10:30:00"
  },
  "message": "Usuario autenticado correctamente"
}
```

**Respuesta (no autenticado):**
```json
{
  "authenticated": false,
  "phone_number": "5491112345678",
  "user_data": null,
  "message": "Usuario no autenticado"
}
```

### 12. Cerrar Sesi√≥n de WhatsApp (DELETE)

**Endpoint:** `DELETE /api/whatsapp/auth/logout?phone_number=5491112345678`

**Sin autenticaci√≥n requerida**

Cierra la sesi√≥n de un usuario de WhatsApp (elimina su autenticaci√≥n).

**Respuesta:**
```json
{
  "success": true,
  "message": "Sesi√≥n cerrada exitosamente para 5491112345678"
}
```

### 13. P√°gina de Autenticaci√≥n (GET)

**Endpoint:** `GET /api/whatsapp/auth/page?token=TOKEN_GENERADO`

**Sin autenticaci√≥n requerida**

P√°gina HTML que redirige autom√°ticamente al flujo de autenticaci√≥n de Microsoft.

**Flujo:**
1. Valida el token de autenticaci√≥n
2. Extrae el n√∫mero de tel√©fono asociado
3. Redirige autom√°ticamente a Microsoft OAuth
4. Pasa el contexto de WhatsApp en el par√°metro state

**Casos:**
- ‚úÖ Token v√°lido: Redirige a Microsoft OAuth
- ‚ùå Token inv√°lido/expirado: Muestra p√°gina de error

### 14. Marcar Mensaje como Le√≠do (Interno)

**M√©todo del servicio:**
```python
await whatsapp_service.mark_message_as_read(message_id)
```

**Funcionalidad:**
- Marca un mensaje recibido como le√≠do
- Muestra doble check azul (‚úì‚úì) al usuario
- Se ejecuta autom√°ticamente al recibir mensajes
- Mejora la experiencia de usuario con feedback visual

## Tipos de Mensajes Soportados

### 1. Texto (text)
- M√°ximo 4096 caracteres
- Soporta emojis
- Puede mostrar preview de URLs

### 2. Imagen (image)
- Formatos: JPG, PNG
- Tama√±o m√°ximo: 5MB
- Caption opcional (max 1024 caracteres)

### 3. Video (video)
- Formatos: MP4, 3GPP
- Tama√±o m√°ximo: 16MB
- Caption opcional

### 4. Documento (document)
- Formatos: PDF, DOC, DOCX, XLS, XLSX, PPT, TXT, etc.
- Tama√±o m√°ximo: 100MB
- Caption opcional

### 5. Audio (audio)
- Formatos: AAC, M4A, AMR, MP3, OGG
- Tama√±o m√°ximo: 16MB

### 6. Ubicaci√≥n (location)
- Coordenadas de latitud y longitud
- Nombre y direcci√≥n opcionales

### 7. Contactos (contacts)
- Compartir informaci√≥n de contacto
- Nombre, tel√©fonos, emails, direcciones, etc.

### 8. Plantilla (template)
- Mensajes pre-aprobados por Meta
- √önico tipo permitido fuera de ventana de 24 horas

### 9. Interactivo (interactive)
- Mensajes con botones (m√°ximo 3)
- Mensajes con listas
- Header, body y footer personalizables

## Formato de N√∫meros de Tel√©fono

Los n√∫meros de tel√©fono deben estar en formato internacional sin el s√≠mbolo +:

- ‚úÖ Correcto: `"5491112345678"` (Argentina)
- ‚úÖ Correcto: `"521234567890"` (M√©xico)
- ‚úÖ Correcto: `"34612345678"` (Espa√±a)
- ‚ùå Incorrecto: `"+5491112345678"`
- ‚ùå Incorrecto: `"1112345678"` (sin c√≥digo de pa√≠s)

## Limitaciones

### Ventana de 24 Horas
- Puedes enviar cualquier tipo de mensaje durante 24 horas despu√©s de que el usuario te escriba
- Despu√©s de 24 horas, solo puedes enviar plantillas aprobadas
- Cuando el usuario responde, la ventana se renueva

### L√≠mites de Mensajer√≠a
- L√≠mite inicial: ~1,000 conversaciones √∫nicas por d√≠a
- Se incrementa autom√°ticamente seg√∫n el uso y calidad
- Consulta l√≠mites actuales en Meta Business Manager

### Restricciones de Contenido
- No spam
- No contenido prohibido (violencia, drogas, etc.)
- No mensajes masivos sin consentimiento
- Seguir pol√≠ticas de Meta

## Seguridad

### Validaci√≥n de Webhook (TODO)
Meta firma los webhooks con `x-hub-signature-256`. Deber√≠as validar esta firma en producci√≥n:

```python
import hmac
import hashlib

def validate_signature(payload: str, signature: str, app_secret: str) -> bool:
    expected_signature = hmac.new(
        app_secret.encode('utf-8'),
        payload.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(f"sha256={expected_signature}", signature)
```

## Testing

### 1. Probar Webhook Verification

```bash
curl "http://localhost:8001/api/whatsapp/webhook?hub.mode=subscribe&hub.verify_token=TU_VERIFY_TOKEN&hub.challenge=CHALLENGE_ACCEPTED"
```

Debe retornar: `CHALLENGE_ACCEPTED`

**Nota**: Reemplaza `TU_VERIFY_TOKEN` con el valor de tu variable `WHATSAPP_VERIFY_TOKEN` del archivo `.env`

### 2. Probar Estado del Servicio

```bash
curl http://localhost:8001/api/whatsapp/status
```

### 3. Enviar Mensaje de Texto

```bash
curl -X POST "http://localhost:8001/api/whatsapp/send/text" \
  -H "Authorization: Bearer TU_TOKEN_JWT" \
  -d "to=5491112345678" \
  -d "message=Hola desde la API"
```

## Logs

El sistema genera logs detallados:

### Logs de Autenticaci√≥n
```
üîí Usuario no autenticado: 5491112345678 (Juan P√©rez)
üîë Token de autenticaci√≥n creado para 5491112345678: xYz123abc4...
üì§ Link de autenticaci√≥n enviado a 5491112345678
üîê Redirigiendo a Microsoft OAuth para WhatsApp user: 5491112345678
‚úÖ Token v√°lido para 5491112345678
‚úÖ Usuario de WhatsApp autenticado exitosamente: 5491112345678
‚úÖ Autenticaci√≥n guardada para 5491112345678
```

### Logs de Mensaje de Texto (Usuario Autenticado)
```
üì± WEBHOOK DE WHATSAPP RECIBIDO
üì¶ Tipo de objeto: whatsapp_business_account
üìã ENTRADA #1
  - WhatsApp Business Account ID: 123456789
  üîÑ CAMBIO #1
    - Campo: messages
    üì® MENSAJES ENTRANTES: 1
      üí¨ MENSAJE #1
        - ID: wamid.XXX
        - De: 5491112345678
        - Tipo: text
        - Contenido: 'Hola'
        - Nombre del contacto: Juan P√©rez
      
      ‚úÖ Marcando mensaje como le√≠do: wamid.XXX
      ‚úÖ Usuario autenticado: 5491112345678 (Juan P√©rez)
      ü§ñ Procesando mensaje text con IA para 5491112345678...
      ü§ñ Generando respuesta de IA para Juan P√©rez
      ‚úÖ Respuesta generada exitosamente
      üì§ Enviando respuesta de IA a Juan P√©rez
      ‚úÖ Respuesta de IA enviada: wamid.YYY
```

### Logs de Mensaje de Audio
```
üì± WEBHOOK DE WHATSAPP RECIBIDO
üì® MENSAJES ENTRANTES: 1
  üí¨ MENSAJE #1
    - ID: wamid.XXX
    - De: 50622703332
    - Tipo: audio
    - Audio ID: 1301795761634718
    - MIME Type: audio/ogg; codecs=opus
    - Es mensaje de voz: S√≠
    - Nombre del contacto: Familia Baltodano
  
  ‚úÖ Marcando mensaje como le√≠do: wamid.XXX
  ‚úÖ Usuario autenticado: 50622703332 (Familia Baltodano)
  ü§ñ Procesando mensaje audio con IA para 50622703332...
  üì• Descargando audio...
  ‚úÖ Audio descargado: 8383 bytes
  üé§ Procesando audio (8383 bytes)
  üéôÔ∏è Transcribiendo audio con Azure OpenAI (8383 bytes, formato: ogg)...
  üì• Respuesta de transcripci√≥n: 200
  ‚úÖ Audio transcrito: 'Hola, ¬øqu√© d√≠a es ma√±ana?'
  ü§ñ Generando respuesta de IA para Familia Baltodano con audio
  ‚úÖ Respuesta generada exitosamente
  üí¨ Respuesta: ¬°Hola! Ma√±ana es s√°bado 18 de octubre...
  üì§ Enviando respuesta de IA a Familia Baltodano (audio)
  ‚úÖ Respuesta de IA enviada: wamid.YYY
  üé§ Audio procesado con IA
```

### Logs de Imagen
```
üì± WEBHOOK DE WHATSAPP RECIBIDO
üì® MENSAJES ENTRANTES: 1
  üí¨ MENSAJE #1
    - Tipo: image
    - Imagen ID: 123456789
    - MIME Type: image/jpeg
    - Caption: 'Mira esta foto'
  
  ‚úÖ Marcando mensaje como le√≠do: wamid.XXX
  ‚úÖ Usuario autenticado: 5491112345678 (Juan P√©rez)
  ü§ñ Procesando mensaje image con IA para 5491112345678...
  üì• Descargando imagen...
  ‚úÖ Imagen descargada: 45231 bytes
  üñºÔ∏è Procesando imagen (45231 bytes)
  ü§ñ Generando respuesta de IA para Juan P√©rez con imagen
  ‚úÖ Respuesta generada exitosamente
  üñºÔ∏è Imagen procesada con IA
```

## M√©todos del Servicio WhatsApp

### Mensajer√≠a

```python
# Enviar texto simple
await whatsapp_service.send_text_message(
    to="5491112345678",
    body="Hola mundo",
    preview_url=True
)

# Enviar imagen
await whatsapp_service.send_image(
    to="5491112345678",
    image_url="https://ejemplo.com/imagen.jpg",
    caption="Mira esta imagen"
)

# Enviar ubicaci√≥n
await whatsapp_service.send_location(
    to="5491112345678",
    latitude=-34.603722,
    longitude=-58.381592,
    name="Obelisco",
    address="Buenos Aires, Argentina"
)

# Marcar como le√≠do
await whatsapp_service.mark_message_as_read("wamid.XXX...")
```

### Autenticaci√≥n

```python
# Crear token de autenticaci√≥n
token = await whatsapp_service.create_auth_token(
    phone_number="5491112345678",
    expires_in_seconds=300  # 5 minutos
)

# Obtener tel√©fono desde token
phone = await whatsapp_service.get_phone_from_auth_token(token)

# Guardar autenticaci√≥n de usuario
await whatsapp_service.save_whatsapp_auth(
    phone_number="5491112345678",
    user_data={
        "codeLogin": 123,
        "email": "usuario@ejemplo.com",
        "name": "Juan P√©rez"
    },
    expires_in_seconds=86400  # 24 horas
)

# Verificar si est√° autenticado
is_auth = await whatsapp_service.is_whatsapp_authenticated("5491112345678")

# Obtener datos de autenticaci√≥n
auth_data = await whatsapp_service.get_whatsapp_auth("5491112345678")

# Extender autenticaci√≥n
await whatsapp_service.extend_whatsapp_auth(
    phone_number="5491112345678",
    expires_in_seconds=86400
)

# Cerrar sesi√≥n (logout)
await whatsapp_service.delete_whatsapp_auth("5491112345678")

# Eliminar token temporal
await whatsapp_service.delete_auth_token(token)
```

## Recursos Adicionales

- [WhatsApp Business API Documentation](https://developers.facebook.com/docs/whatsapp)
- [Meta for Developers](https://developers.facebook.com/)
- [WhatsApp Business Platform](https://business.whatsapp.com/products/business-platform)
