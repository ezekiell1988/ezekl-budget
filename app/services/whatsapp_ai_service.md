# WhatsApp AI Service - Documentaci√≥n

## üìã Descripci√≥n

Servicio de inteligencia artificial para WhatsApp que proporciona respuestas autom√°ticas usando Azure OpenAI. Integra **GPT-5** (o1 reasoning model) para generar respuestas contextuales e inteligentes, con soporte multimodal para **texto, im√°genes, audios y documentos PDF**.

**Caracter√≠sticas principales:**
- ü§ñ Respuestas inteligentes con GPT-5
- üé§ Transcripci√≥n de audio a texto con gpt-4o-transcribe
- üñºÔ∏è Procesamiento de im√°genes
- üìÑ **An√°lisis directo de documentos PDF (sin extracci√≥n de texto)**
- ‚úì‚úì Marcado autom√°tico de mensajes como le√≠dos
- üí¨ Historial de conversaci√≥n por usuario
- üîÑ Respuestas autom√°ticas contextuales

---

## üèóÔ∏è Arquitectura

```
Usuario WhatsApp ‚Üí Meta Webhook ‚Üí FastAPI ‚Üí WhatsApp AI Service
                        ‚Üì                           ‚Üì
                   ‚úì‚úì Le√≠do                  Procesamiento:
                                              - Texto ‚Üí GPT-5
                                              - Audio ‚Üí Transcripci√≥n ‚Üí GPT-5
                                              - Imagen ‚Üí GPT-5
                        ‚Üì                           ‚Üì
                  WhatsApp API ‚Üê Respuesta Autom√°tica ‚Üê Azure OpenAI
```

### Flujo de Conversaci√≥n Completo

1. **Recepci√≥n**: Usuario env√≠a mensaje (texto/audio/imagen) por WhatsApp
2. **Webhook**: Meta env√≠a notificaci√≥n al endpoint `/api/whatsapp/webhook`
3. **‚úì‚úì Marcado como le√≠do**: Se marca el mensaje con doble check azul inmediatamente
4. **Procesamiento multimodal**:
   - **Audio**: Transcripci√≥n autom√°tica con Azure OpenAI (gpt-4o-transcribe)
   - **Imagen**: An√°lisis visual con GPT-5
   - **Texto**: Procesamiento directo
5. **IA**: GPT-5 genera respuesta contextual basada en el historial
6. **Env√≠o**: La respuesta se env√≠a autom√°ticamente al usuario por WhatsApp

---

## üöÄ Caracter√≠sticas Principales

### ‚úÖ Respuestas Autom√°ticas con IA
- Respuestas generadas por **GPT-5** (o1 reasoning model) de Azure OpenAI
- Contextualizadas seg√∫n el negocio (Ezekl Budget)
- Tono profesional pero amigable
- Reasoning avanzado para respuestas m√°s inteligentes

### üé§ Procesamiento de Audio
- Transcripci√≥n autom√°tica con **gpt-4o-transcribe** de Azure OpenAI
- Soporta m√∫ltiples formatos: OGG, MP3, WAV, M4A
- Transcripci√≥n directa sin conversi√≥n de formato
- La transcripci√≥n se procesa naturalmente como texto por GPT-5
- Sin prefijos artificiales - respuesta natural al contenido del audio

### üñºÔ∏è Procesamiento de Im√°genes
- An√°lisis visual con GPT-5 (visi√≥n multimodal)
- Soporta JPG, PNG, WebP
- Caption opcional con la imagen
- Respuestas contextuales sobre el contenido visual

### üìÑ Procesamiento de PDFs
- **An√°lisis directo por GPT-5**: El modelo recibe el PDF completo codificado en base64
- **Sin extracci√≥n de texto**: No se usa PyPDF2 ni librer√≠as externas
- **Procesamiento nativo**: GPT-5 analiza el PDF directamente como lo hace con im√°genes
- **Con o sin caption**: Puedes enviar solo el PDF o acompa√±arlo con una pregunta
- **Respuesta inmediata**: El modelo analiza y responde en el mismo mensaje
- **Sin l√≠mites artificiales**: El modelo determina cu√°nto puede procesar del documento

### ‚úì‚úì Confirmaci√≥n de Lectura
- Marca mensajes como le√≠dos autom√°ticamente
- Doble check azul aparece inmediatamente
- Mejor experiencia de usuario con feedback visual

### üí¨ Gesti√≥n de Historial
- Mantiene historial de conversaci√≥n por usuario
- M√°ximo configurable de mensajes por conversaci√≥n (default: 10)
- Posibilidad de limpiar historial manualmente
- Contexto completo en cada interacci√≥n

### üéØ Personalizaci√≥n
- Respuestas adaptadas al nombre del usuario
- Sistema de instrucciones personalizable
- L√≠mite de tokens configurable para WhatsApp
- Max 8000 tokens de completition para reasoning (GPT-5)

### üõ°Ô∏è Manejo de Errores
- Respuesta de fallback autom√°tica en caso de error
- Logging detallado de todas las operaciones
- Manejo graceful de excepciones
- Recuperaci√≥n autom√°tica de errores de transcripci√≥n

---

## üì¶ Componentes

### 1. `whatsapp_ai_service.py`

Servicio principal que maneja:
- Inicializaci√≥n de Azure OpenAI client
- Gesti√≥n de historial de conversaciones
- Generaci√≥n de respuestas con IA
- Integraci√≥n con WhatsApp Business API

### 2. Endpoints en `whatsapp.py`

#### Webhook (Autom√°tico)
```http
POST /api/whatsapp/webhook
```
- Recibe mensajes de WhatsApp autom√°ticamente
- Marca mensajes como le√≠dos (‚úì‚úì azul) inmediatamente
- Procesa con IA y responde autom√°ticamente
- Soporta: **texto, im√°genes, audios y documentos PDF**
- Audio: transcribe autom√°ticamente antes de procesar
- Imagen: analiza contenido visual con GPT-5
- **PDF: env√≠a el documento completo directamente a GPT-5 para an√°lisis**

#### Chat con IA (Manual)
```http
POST /api/whatsapp/ai/chat
```
**Par√°metros:**
- `message`: Mensaje del usuario
- `phone_number`: N√∫mero de tel√©fono (para contexto)
- `contact_name`: Nombre opcional del contacto

**Respuesta:**
```json
{
  "response": "¬°Hola! üëã Soy el asistente de Ezekl Budget...",
  "phone_number": "5491112345678",
  "contact_name": "Juan P√©rez"
}
```

#### Enviar Respuesta de IA
```http
POST /api/whatsapp/ai/reply
```
**Par√°metros:**
- `message`: Mensaje del usuario
- `phone_number`: N√∫mero destino
- `contact_name`: Nombre opcional

**Respuesta:**
```json
{
  "success": true,
  "ai_response": "Respuesta generada...",
  "whatsapp_message_id": "wamid.xxx"
}
```

#### Limpiar Historial
```http
DELETE /api/whatsapp/ai/history/{phone_number}
```

#### Estad√≠sticas
```http
GET /api/whatsapp/ai/statistics
```
**Respuesta:**
```json
{
  "active_conversations": 5,
  "total_messages": 42,
  "max_history_per_conversation": 10
}
```

---

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno (.env)

```bash
# Azure OpenAI - Chat (GPT-5) (requerido)
AZURE_OPENAI_ENDPOINT=https://tu-recurso.cognitiveservices.azure.com
AZURE_OPENAI_API_KEY=tu_api_key
AZURE_OPENAI_CHAT_DEPLOYMENT_NAME=gpt-5  # Deployment de GPT-5 para chat
AZURE_OPENAI_API_VERSION=2024-12-01-preview

# Azure OpenAI - Audio Transcription (requerido para audios)
AZURE_OPENAI_AUDIO_DEPLOYMENT_NAME=gpt-4o-transcribe  # Deployment de transcripci√≥n
AZURE_OPENAI_AUDIO_API_VERSION=2025-03-01-preview

# WhatsApp Business API (requerido)
WHATSAPP_ACCESS_TOKEN=tu_token
WHATSAPP_PHONE_NUMBER_ID=tu_phone_id
WHATSAPP_API_VERSION=v21.0
```

### Personalizaci√≥n del Servicio

En `whatsapp_ai_service.py`, puedes modificar:

#### System Prompt
```python
self.system_prompt = """Eres un asistente virtual de Ezekl Budget...
Tu funci√≥n es:
- Responder consultas sobre la aplicaci√≥n
- Ayudar con dudas sobre presupuestos
...
"""
```

#### Par√°metros de Configuraci√≥n
```python
self.max_history_messages = 10      # Mensajes a recordar
self.max_response_tokens = 150      # Tokens m√°ximos (m√°s corto)
```

#### Par√°metros de Generaci√≥n
```python
temperature=0.7,           # Creatividad (0.0 - 2.0)
max_tokens=150,            # Longitud de respuesta
top_p=0.9,                 # Nucleus sampling
frequency_penalty=0.5,     # Penalizaci√≥n repetici√≥n
presence_penalty=0.5       # Penalizaci√≥n temas
```

---

## üîß Uso

### 1. Respuesta Autom√°tica (Recomendado)

El servicio est√° configurado para responder autom√°ticamente a mensajes de **texto, audio e im√°genes**:

```python
# Ya configurado en whatsapp.py
if message.type in ["text", "image", "audio"]:
    # ‚úì‚úì Marcar como le√≠do inmediatamente
    await whatsapp_service.mark_message_as_read(message.id)
    
    # Procesar seg√∫n tipo
    if message.type == "text":
        user_text = message.text.body
        
    elif message.type == "image":
        # Descargar y procesar imagen
        image_data = await whatsapp_service.get_media_content(message.image.id)
        user_text = message.image.caption or "¬øQu√© ves en esta imagen?"
        
    elif message.type == "audio":
        # Descargar audio - la transcripci√≥n es autom√°tica
        audio_data = await whatsapp_service.get_media_content(message.audio.id)
        user_text = None  # La transcripci√≥n reemplazar√° esto
    
    elif message.type == "document":
        # Descargar documento PDF
        document_data = await whatsapp_service.get_media_content(message.document.id)
        pdf_data = document_data
        filename = message.document.filename
        user_text = None  # El texto se extrae del PDF autom√°ticamente
    
    # Generar y enviar respuesta
    ai_result = await whatsapp_ai_service.process_and_reply(
        user_message=user_text,
        phone_number=message.from_,
        contact_name=contact_name,
        image_data=image_data,
        audio_data=audio_data,
        pdf_data=pdf_data,
        filename=filename,
        media_type=media_type
    )
```

### 2. Uso Program√°tico

```python
from app.services.whatsapp_ai_service import whatsapp_ai_service

# Solo generar respuesta (sin enviar)
response = await whatsapp_ai_service.generate_response(
    user_message="¬øC√≥mo creo un presupuesto?",
    phone_number="5491112345678",
    contact_name="Juan"
)

# Generar y enviar autom√°ticamente
result = await whatsapp_ai_service.process_and_reply(
    user_message="¬øC√≥mo creo un presupuesto?",
    phone_number="5491112345678",
    contact_name="Juan"
)

# Procesar PDF
result = await whatsapp_ai_service.process_and_reply(
    user_message="¬øCu√°l es el presupuesto total?",  # Pregunta sobre el PDF
    phone_number="5491112345678",
    contact_name="Juan",
    pdf_data=pdf_bytes,
    filename="documento.pdf"
)

# O enviar PDF sin pregunta para an√°lisis general
result = await whatsapp_ai_service.process_and_reply(
    user_message=None,  # Sin pregunta espec√≠fica
    phone_number="5491112345678",
    contact_name="Juan",
    pdf_data=pdf_bytes,
    filename="presupuesto.pdf"
)

# Limpiar historial de un usuario
whatsapp_ai_service.clear_history("5491112345678")

# Obtener estad√≠sticas
stats = whatsapp_ai_service.get_statistics()
```

---

## üìä Logging

El servicio registra informaci√≥n detallada para cada operaci√≥n:

### Logs de Texto
```
‚úÖ Marcando mensaje como le√≠do: wamid.XXX
ü§ñ Generando respuesta de IA para Juan P√©rez
üìù Mensaje del usuario: ¬øC√≥mo creo un presupuesto?
üîß Usando deployment: gpt-5
üìä Token usage - Prompt: 192, Completion: 714, Total: 906
üß† Reasoning tokens: 640
üìù Visible tokens: 74
‚úÖ Respuesta generada exitosamente
üí¨ Respuesta: Para crear un presupuesto en Ezekl Budget...
üì§ Enviando respuesta de IA a Juan P√©rez
‚úÖ Respuesta de IA enviada exitosamente
```

### Logs de Audio
```
‚úÖ Marcando mensaje como le√≠do: wamid.XXX
üì• Descargando audio...
‚úÖ Audio descargado: 8383 bytes
üé§ Procesando audio (8383 bytes)
üéôÔ∏è Transcribiendo audio con Azure OpenAI (8383 bytes, formato: ogg)...
üì° URL: .../gpt-4o-transcribe/audio/transcriptions?api-version=2025-03-01-preview
üì• Respuesta de transcripci√≥n: 200
‚úÖ Audio transcrito: 'Hola, ¬øqu√© d√≠a es ma√±ana?'
ü§ñ Generando respuesta de IA para Juan P√©rez con audio
üìù Mensaje del usuario: Hola, ¬øqu√© d√≠a es ma√±ana?
‚úÖ Respuesta generada exitosamente
üí¨ Respuesta: ¬°Hola! Ma√±ana es s√°bado 18 de octubre...
```

### Logs de Imagen
```
‚úÖ Marcando mensaje como le√≠do: wamid.XXX
üì• Descargando imagen...
‚úÖ Imagen descargada: 45231 bytes
üñºÔ∏è Procesando imagen (45231 bytes)
ü§ñ Generando respuesta de IA para Juan P√©rez con imagen
‚úÖ Respuesta generada exitosamente
üí¨ Respuesta: Veo en la imagen...
```

### Logs de PDF
```
‚úÖ Marcando mensaje como le√≠do: wamid.XXX
üì• Descargando documento...
‚úÖ Documento descargado: 125847 bytes
üìÑ Procesando PDF: presupuesto.pdf (125847 bytes)
ü§ñ Generando respuesta de IA para Juan P√©rez con PDF
‚úÖ Respuesta generada exitosamente
üí¨ Respuesta: Este presupuesto anual tiene un total de $450,000...
```

---

## üéØ Mejores Pr√°cticas

### 1. Mant√©n las Respuestas Cortas
WhatsApp funciona mejor con respuestas concisas:
```python
max_response_tokens = 150  # ~100-150 palabras
```

### 2. Usa Emojis con Moderaci√≥n
Los emojis hacen las respuestas m√°s amigables pero no abuses:
```python
"¬°Hola! üëã Puedo ayudarte con Ezekl Budget"  # ‚úÖ Bien
"¬°¬°¬°Hola!!! üëãüòäüéâüí∞üì±"                     # ‚ùå Demasiado
```

### 3. Proporciona Informaci√≥n de Contacto
Siempre ofrece alternativas si la IA no puede ayudar:
```python
"Si necesitas ayuda adicional, contacta a soporte@ezeklbudget.com"
```

### 4. Limpia el Historial Peri√≥dicamente
Para conversaciones largas o problemas de contexto:
```python
whatsapp_ai_service.clear_history(phone_number)
```

---

## üîí Seguridad

### Autenticaci√≥n
Todos los endpoints manuales requieren autenticaci√≥n:
```python
current_user: dict = Depends(get_current_user)
```

### Validaci√≥n de Webhook
Meta env√≠a firma `x-hub-signature-256` para validar la autenticidad:
```python
# TODO: Implementar validaci√≥n de firma
x_hub_signature_256: Optional[str] = Header(None)
```

---

## üêõ Troubleshooting

### Error: "Cliente de Azure OpenAI no inicializado"
**Causa**: Variables de entorno faltantes
**Soluci√≥n**: Verificar `.env` tiene `AZURE_OPENAI_*` configurado

### Error: "WhatsApp no configurado"
**Causa**: Credenciales de WhatsApp faltantes
**Soluci√≥n**: Verificar `WHATSAPP_ACCESS_TOKEN` y `WHATSAPP_PHONE_NUMBER_ID`

### La IA no responde autom√°ticamente
**Causa**: Webhook no configurado correctamente en Meta
**Soluci√≥n**: 
1. Verificar URL del webhook en Meta Developer Console
2. Verificar que el webhook est√© suscrito a eventos "messages"
3. Revisar logs del servidor

### Respuestas muy largas
**Causa**: `max_response_tokens` muy alto
**Soluci√≥n**: Reducir a 100-150 tokens para WhatsApp

---

## üìà M√©tricas y Monitoreo

### Estad√≠sticas Disponibles
```python
stats = whatsapp_ai_service.get_statistics()
# {
#   "active_conversations": 5,
#   "total_messages": 42,
#   "max_history_per_conversation": 10
# }
```

### Logs Importantes
- ‚úÖ Respuestas exitosas
- ‚ùå Errores de IA o WhatsApp
- ü§ñ Mensajes procesados
- üìä Tokens utilizados

---

## ‚úÖ Funcionalidades Completadas

- [x] ‚úÖ **Soporte multimodal**: texto, im√°genes, audios y PDFs
- [x] ‚úÖ **Transcripci√≥n de audio**: gpt-4o-transcribe integrado
- [x] ‚úÖ **Procesamiento de im√°genes**: GPT-5 visi√≥n multimodal
- [x] ‚úÖ **Procesamiento de PDFs**: an√°lisis directo por GPT-5 sin extracci√≥n de texto
- [x] ‚úÖ **Marcado de mensajes como le√≠dos**: doble check azul autom√°tico
- [x] ‚úÖ **Respuestas autom√°ticas con GPT-5**: o1 reasoning model
- [x] ‚úÖ **Historial de conversaci√≥n**: contexto por usuario
- [x] ‚úÖ **HTTPClient optimizado**: multipart/form-data para audios
- [x] ‚úÖ **Sin dependencias externas**: eliminado ffmpeg y PyPDF2

## üöÄ Pr√≥ximas Mejoras

- [ ] Implementar validaci√≥n de firma `x-hub-signature-256`
- [ ] Soporte para videos con transcripci√≥n
- [ ] Persistencia de historial en base de datos
- [ ] Analytics y m√©tricas avanzadas
- [ ] Rate limiting por usuario
- [ ] A/B testing de prompts
- [ ] Integraci√≥n con CRM para contexto de usuarios
- [ ] Respuestas con botones interactivos
- [ ] Multi-idioma autom√°tico
- [ ] Streaming de respuestas para mensajes largos
- [ ] Cache de transcripciones de audio

---

## üìù Ejemplos Completos

### Ejemplo 1: Conversaci√≥n de Texto

**Usuario**: "Hola, ¬øqu√© es Ezekl Budget?"

**Sistema**: ‚úì‚úì (marca como le√≠do)

**IA**: "¬°Hola! üëã Ezekl Budget es una aplicaci√≥n completa de gesti√≥n financiera y presupuestos que te ayuda a organizar tus finanzas personales. ¬øTe gustar√≠a saber m√°s sobre alguna funcionalidad espec√≠fica?"

**Usuario**: "¬øC√≥mo creo mi primer presupuesto?"

**Sistema**: ‚úì‚úì (marca como le√≠do)

**IA**: "Para crear tu primer presupuesto en Ezekl Budget:

1. Ingresa a la app üì±
2. Ve a 'Presupuestos' 
3. Toca el bot√≥n '+'
4. Define nombre, monto y categor√≠as

¬øNecesitas ayuda con algo m√°s espec√≠fico?"

---

### Ejemplo 2: Mensaje de Audio

**Usuario**: üé§ *[Env√≠a audio de voz: "Hola, ¬øqu√© d√≠a es ma√±ana?"]*

**Sistema**: 
1. ‚úì‚úì Marca como le√≠do
2. üéôÔ∏è Transcribe: "Hola, ¬øqu√© d√≠a es ma√±ana?"
3. ü§ñ GPT-5 procesa la transcripci√≥n

**IA**: "¬°Hola! Ma√±ana es s√°bado 18 de octubre de 2025. ¬øNecesitas ayuda con algo relacionado a tus finanzas o presupuestos? üòä"

---

### Ejemplo 3: Imagen con Caption

**Usuario**: üñºÔ∏è *[Env√≠a imagen de un recibo]* + Caption: "¬øPuedo agregar esto a mi presupuesto?"

**Sistema**:
1. ‚úì‚úì Marca como le√≠do
2. üì• Descarga imagen
3. ü§ñ GPT-5 analiza visualmente

**IA**: "¬°Claro! Veo en el recibo un gasto de $1,250 en supermercado del 17 de octubre. Puedes agregarlo a tu presupuesto en la categor√≠a 'Alimentaci√≥n'. ¬øQuieres que te gu√≠e en el proceso? üìä"

---

### Ejemplo 4: Documento PDF (An√°lisis Directo)

**Usuario**: üìÑ *[Env√≠a archivo: "presupuesto_anual_2025.pdf"]*

**Sistema**:
1. ‚úì‚úì Marca como le√≠do
2. üì• Descarga documento (125,847 bytes)
3. ÔøΩ Codifica PDF en base64
4. ü§ñ GPT-5 analiza el PDF completo

**IA**: "He analizado el presupuesto anual 2025. El documento contiene:

üìä **Resumen Ejecutivo:**
- Presupuesto total: $450,000
- Distribuido en 6 departamentos
- Per√≠odo: Enero - Diciembre 2025

**Principales partidas:**
- Marketing: $45,000 (10%)
- Recursos Humanos: $180,000 (40%)
- Operaciones: $150,000 (33%)
- Tecnolog√≠a: $45,000 (10%)
- Administraci√≥n: $30,000 (7%)

¬øTe gustar√≠a que profundice en alg√∫n √°rea espec√≠fica? üìà"

**Usuario**: "Desglosame el presupuesto de marketing"

**Sistema**:
1. ‚úì‚úì Marca como le√≠do
2. ü§ñ GPT-5 usa el historial (ya tiene el PDF en contexto)

**IA**: "Seg√∫n el documento, el presupuesto de Marketing ($45,000) se distribuye as√≠:

üí∞ **Desglose detallado:**
- Publicidad digital: $20,000 (44%)
  - Google Ads: $10,000
  - Meta Ads: $7,000
  - LinkedIn Ads: $3,000
- Eventos y ferias: $15,000 (33%)
- Material promocional: $10,000 (23%)
  - Dise√±o gr√°fico: $4,000
  - Impresi√≥n: $6,000

El documento indica que es un incremento del 15% respecto al a√±o anterior. ¬øNecesitas m√°s detalles? ÔøΩ"

---
3. üñºÔ∏è GPT-5 analiza imagen + caption

**IA**: "Claro que s√≠! Veo que es un recibo de compra. Para agregarlo a tu presupuesto en Ezekl Budget:

1. Abre la app
2. Ve a 'Gastos'
3. Toca '+' para nuevo gasto
4. Ingresa el monto y categor√≠a
5. Opcional: Adjunta la foto del recibo

¬øNecesitas ayuda con algo m√°s?"

---

## üìû Contacto y Soporte

- **Email**: soporte@ezeklbudget.com
- **Documentaci√≥n**: https://ezeklbudget.com/docs
- **API Reference**: https://api.ezeklbudget.com/docs

---

## üìÑ Licencia

Este c√≥digo es parte del proyecto Ezekl Budget.
