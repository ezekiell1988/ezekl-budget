<app-header title="Chat Copilot Studio" [showMenu]="true"></app-header>

<ion-content [fullscreen]="true">
  <ion-grid fixed>
    <!-- Selector de modo -->
    <div class="ion-text-center ion-margin-bottom">
      <ion-segment [(ngModel)]="chatMode" (ionChange)="onChatModeChange()">
        <ion-segment-button value="custom">
          <ion-label>Chat Personalizado</ion-label>
        </ion-segment-button>
        <ion-segment-button value="embed">
          <ion-label>Embed Directo</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Modo Embed (iframe) -->
    @if (chatMode === 'embed') {
      <ion-card class="embed-card">
        <ion-card-content class="embed-container">
          <iframe
            src="https://copilotstudio.microsoft.com/environments/3c48723d-81b5-473a-9006-a54c8652fe7c/bots/cr389_agent_ROzgg7/webchat?__version__=2"
            frameborder="0"
            style="width: 100%; height: 600px; border: none;">
          </iframe>
        </ion-card-content>
      </ion-card>
    }

    <!-- Modo Custom (chat personalizado con Direct Line) -->
    @if (chatMode === 'custom') {
      <!-- Estado de conexión -->
      <div class="ion-text-center ion-margin-bottom">
        <ion-chip [color]="isConnected ? 'success' : isConnecting ? 'warning' : 'danger'">
          <ion-icon [name]="isConnected ? 'wifi' : isConnecting ? 'refresh' : 'cloud-offline'"></ion-icon>
          <ion-label>{{ connectionStatusText }}</ion-label>
        </ion-chip>
      </div>

      <!-- Área de mensajes -->
      <ion-card class="chat-card">
        <ion-card-content class="chat-container" #chatContainer>
        @for (message of messages; track message.id) {
          <ion-card [class.message-user]="message.role === 'user'" [class.message-bot]="message.role === 'bot'">
            <ion-card-content>
              <ion-text>
                <p class="text-message">{{ message.text }}</p>
              </ion-text>

              <div class="message-footer">
                <ion-note color="medium">
                  <small>{{ formatTime(message.timestamp) }}</small>
                </ion-note>
              </div>
            </ion-card-content>
          </ion-card>
        }

        @if (isBotTyping) {
          <ion-card class="message-bot">
            <ion-card-content>
              <div class="typing-indicator">
                <ion-spinner name="dots" color="medium"></ion-spinner>
                <ion-label color="medium">Escribiendo...</ion-label>
              </div>
            </ion-card-content>
          </ion-card>
        }

        @if (messages.length === 0 && !isConnecting) {
          <div class="empty-state ion-text-center">
            <ion-icon name="chatbubbles-outline" color="medium"></ion-icon>
            <ion-text color="medium">
              <p>Inicia una conversación con el agente de Copilot Studio</p>
            </ion-text>
          </div>
        }
        </ion-card-content>
      </ion-card>

      <!-- Input de texto y controles -->
      <ion-toolbar class="chat-input-toolbar">
      <!-- Campo de texto -->
      <ion-input
        [(ngModel)]="messageText"
        placeholder="Escribe un mensaje..."
        (keydown.enter)="sendMessage()"
        [disabled]="!isConnected"
        fill="outline">
      </ion-input>

      <ion-buttons slot="end">
        <!-- Botón enviar -->
        <ion-button
          color="primary"
          (click)="sendMessage()"
          [disabled]="!isConnected || !messageText.trim()">
          <ion-icon slot="icon-only" name="send"></ion-icon>
        </ion-button>
        </ion-buttons>
      </ion-toolbar>
    }
  </ion-grid>
</ion-content>
