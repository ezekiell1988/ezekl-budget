<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/"></ion-back-button>
    </ion-buttons>
    <ion-title>Exam Questions</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="handleRefresh($event)">
        <ion-icon name="refresh" slot="icon-only" color="light"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Selector de examen -->
  <ion-toolbar>
    <ion-select placeholder="Selecciona un examen" [value]="selectedExam?.id" (ionChange)="onExamSelected($event)"
      interface="popover" class="exam-selector">
      @for (pdf of availablePdfs; track pdf.id) {
      <ion-select-option [value]="pdf.id">
        {{ pdf.displayName }}
      </ion-select-option>
      }
    </ion-select>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- Sin examen seleccionado -->
  @if (!selectedExam) {
  <div class="ion-padding ion-text-center" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
    <ion-icon name="document-text" size="large" color="medium"></ion-icon>
    <h2 class="ion-margin-top">Selecciona un examen</h2>
    <p class="ion-text-color-medium">Elige un PDF del menú superior para comenzar</p>
  </div>
  }

  <!-- Con examen seleccionado -->
  @if (selectedExam) {
  <div class="split-container">
    <!-- Panel izquierdo: PDF (80%) -->
    <div class="pdf-panel" #pdfContainer>
      <div class="pdf-controls">
        <ion-button size="small" fill="clear" (click)="goToPreviousPage()" [disabled]="currentPdfPage <= 1">
          <ion-icon name="chevron-up" slot="icon-only"></ion-icon>
        </ion-button>

        <div class="page-navigation">
          <ion-text color="medium">Página</ion-text>
          <input
            type="number"
            class="page-input"
            [value]="currentPdfPage"
            (change)="onPageInputChange($event)"
            (keyup.enter)="onPageInputChange($event)"
            min="1"
            [max]="totalPages"
          />
          <ion-text color="medium">de {{ totalPages }}</ion-text>
        </div>

        <ion-button size="small" fill="clear" (click)="goToNextPage()" [disabled]="currentPdfPage >= totalPages">
          <ion-icon name="chevron-down" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <div class="pdf-viewer">
        <!-- Skeleton mientras carga el PDF -->
        @if (loadingPdf) {
        <div style="display: flex; flex-direction: column; align-items: center; gap: 16px; width: 100%;">
          @for (item of [1,2,3]; track item) {
          <ion-card style="width: 100%; max-width: 800px; margin: 0;">
            <ion-card-content class="ion-no-padding">
              <ion-skeleton-text [animated]="true" style="width: 100%; height: 800px;"></ion-skeleton-text>
            </ion-card-content>
          </ion-card>
          }
        </div>
        }

        <!-- PDF Container - siempre presente -->
        <div id="pdf-container" class="pdf-container" [class.hidden]="loadingPdf"></div>
      </div>
    </div>

    <!-- Panel derecho: Preguntas (20%) -->
    <div class="questions-panel" #questionsList>
      <!-- Controles de navegación de preguntas -->
      <div class="questions-controls">
        <ion-button size="small" fill="clear" (click)="goToPreviousQuestion()" [disabled]="currentQuestionIndex <= 0 || questions.length === 0">
          <ion-icon name="chevron-up" slot="icon-only"></ion-icon>
        </ion-button>

        <div class="question-navigation">
          <ion-text color="medium">Pregunta</ion-text>
          <input
            type="number"
            class="question-input"
            [value]="currentQuestionIndex >= 0 && questions.length > 0 ? questions[currentQuestionIndex]?.numberQuestion : ''"
            (change)="onQuestionInputChange($event)"
            (keyup.enter)="onQuestionInputChange($event)"
            min="1"
            [placeholder]="questions.length > 0 ? '1-' + totalQuestions : ''"
            [disabled]="questions.length === 0"
          />
          <ion-text color="medium">de {{ totalQuestions }}</ion-text>
        </div>

        <ion-button size="small" fill="clear" (click)="goToNextQuestion()" [disabled]="currentQuestionIndex >= questions.length - 1 || questions.length === 0">
          <ion-icon name="chevron-down" slot="icon-only"></ion-icon>
        </ion-button>
      </div>

      <ion-content class="questions-content">
        <!-- Skeleton mientras carga pregunta específica -->
        @if (loadingSpecificQuestion) {
        <ion-card color="light" style="margin: 16px;">
          <ion-card-content>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <ion-icon name="time-outline" size="large" color="primary"></ion-icon>
              <div style="flex: 1;">
                <h3 style="margin: 0 0 4px 0; font-weight: 600;">Cargando pregunta...</h3>
                <p style="margin: 0; font-size: 14px; color: var(--ion-color-medium);">
                  Buscando y cargando la pregunta solicitada
                </p>
              </div>
            </div>
            <ion-list lines="full">
              @for (item of [1,2,3]; track item) {
              <ion-item>
                <ion-label>
                  <h3>
                    <ion-skeleton-text [animated]="true" style="width: 30%;"></ion-skeleton-text>
                  </h3>
                  <p>
                    <ion-skeleton-text [animated]="true" style="width: 90%;"></ion-skeleton-text>
                    <ion-skeleton-text [animated]="true" style="width: 80%;"></ion-skeleton-text>
                  </p>
                  <ion-skeleton-text [animated]="true" style="width: 50%;"></ion-skeleton-text>
                </ion-label>
              </ion-item>
              }
            </ion-list>
          </ion-card-content>
        </ion-card>
        }

        <!-- Skeleton mientras carga preguntas iniciales -->
        @if (loading && questions.length === 0 && !loadingSpecificQuestion) {
        <ion-list lines="full">
          @for (item of [1,2,3,4,5]; track item) {
          <ion-item>
            <ion-label>
              <h3>
                <ion-skeleton-text [animated]="true" style="width: 30%;"></ion-skeleton-text>
              </h3>
              <p>
                <ion-skeleton-text [animated]="true" style="width: 90%;"></ion-skeleton-text>
                <ion-skeleton-text [animated]="true" style="width: 80%;"></ion-skeleton-text>
              </p>
              <ion-skeleton-text [animated]="true" style="width: 50%;"></ion-skeleton-text>
            </ion-label>
          </ion-item>
          }
        </ion-list>
        }

        <!-- Lista de preguntas -->
        @if ((!loading || questions.length > 0) && !loadingSpecificQuestion) {
        <ion-list lines="full">
          @for (question of questions; track question.numberQuestion) {
          <ion-item [id]="'question-' + question.numberQuestion" button (click)="onQuestionClick(question)"
            [detail]="false" class="question-item">
            <ion-label class="ion-text-wrap">
              <h3>
                <ion-text color="primary">
                  <strong>Q{{ question.numberQuestion }}</strong>
                </ion-text>
                @if (question.startPage) {
                <ion-text color="medium" class="page-badge">
                  (p.{{ question.startPage }}@if (question.endPage && question.endPage !== question.startPage) {-{{
                  question.endPage }}})
                </ion-text>
                }
              </h3>
              <p class="question-text">{{ question.shortQuestion }}</p>
              @if (question.correctAnswer) {
              <ion-chip color="success" class="correct-answer-chip">
                <ion-icon name="checkmark-circle"></ion-icon>
                <ion-label>
                  <strong>Respuesta:</strong> {{ question.correctAnswer }}
                </ion-label>
              </ion-chip>
              }
            </ion-label>
          </ion-item>
          }
        </ion-list>

        <!-- Infinite Scroll -->
        <ion-infinite-scroll threshold="100px" [disabled]="!hasMore" (ionInfinite)="onIonInfinite($event)">
          <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Cargando más preguntas...">
          </ion-infinite-scroll-content>
        </ion-infinite-scroll>
        }

        <!-- Sin preguntas -->
        @if (!loading && questions.length === 0 && !loadingSpecificQuestion) {
        <div class="ion-padding ion-text-center" style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
          <ion-icon name="alert-circle" size="large" color="warning"></ion-icon>
          <h3 class="ion-margin-top">No hay preguntas</h3>
          <p class="ion-text-color-medium">No se encontraron preguntas para este examen</p>
        </div>
        }
      </ion-content>
    </div>
  </div>
  }

  <!-- Alert -->
  @if (showAlert) {
  <ion-alert [isOpen]="showAlert" [message]="alertMessage" [buttons]="['OK']" (didDismiss)="closeAlert()">
  </ion-alert>
  }

  <!-- Toast -->
  @if (showToast) {
  <ion-toast [isOpen]="showToast" [message]="toastMessage" [duration]="2000" position="bottom"
    (didDismiss)="closeToast()">
  </ion-toast>
  }
</ion-content>
