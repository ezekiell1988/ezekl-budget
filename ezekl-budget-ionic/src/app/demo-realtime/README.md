# Demo Realtime - Azure OpenAI Realtime API

## üìã Descripci√≥n

Implementaci√≥n completa de un chat en tiempo real estilo WhatsApp que integra la API de Azure OpenAI Realtime. Soporta conversaciones por voz y texto con transcripci√≥n en tiempo real, detecci√≥n de voz (VAD) del lado del servidor, y reproducci√≥n autom√°tica de respuestas de audio.

---

## üèóÔ∏è Arquitectura de la Soluci√≥n

### Tecnolog√≠as Utilizadas

- **Frontend**: Ionic 8.0.0 + Angular 20.0.0 (Standalone Components)
- **Backend**: FastAPI con endpoints para credenciales de Azure
- **Azure AI**: Azure OpenAI Realtime API
  - **Deployment**: `gpt-realtime` (Sweden Central)
  - **API Version**: `2024-10-01-preview`
  - **Regi√≥n**: Sweden Central (disponibilidad regional)
- **Audio Processing**: Web Audio API + AudioWorklet
- **WebSocket**: Comunicaci√≥n bidireccional en tiempo real

---

## üì¶ Interfaces y Modelos

### `RealtimeCredentials`
```typescript
interface RealtimeCredentials {
  azure_openai_endpoint: string;     // URL del endpoint de Azure OpenAI
  azure_openai_api_key: string;      // API Key para autenticaci√≥n
  azure_openai_deployment_name: string; // Nombre del deployment (ej: gpt-4o-realtime)
  server_os?: string;                // Sistema operativo del servidor (opcional)
  message: string;                   // Mensaje de estado
}
```

**Prop√≥sito**: Almacenar las credenciales necesarias para conectarse a Azure OpenAI Realtime API.

---

### `ChatMessage`
```typescript
interface ChatMessage {
  id: string;                  // ID √∫nico del mensaje (del servidor o generado)
  role: 'user' | 'assistant';  // Rol del emisor
  type: 'text' | 'audio';      // Tipo de mensaje
  content: string;             // Contenido del mensaje o transcripci√≥n
  timestamp: string;           // Marca de tiempo ISO
  audioBlob?: Blob;            // Blob de audio para reproducci√≥n (opcional)
  transcription?: string;      // Transcripci√≥n del audio (opcional)
  tokens?: number;             // Cantidad de tokens utilizados (opcional)
  isTranscribing?: boolean;    // Si est√° transcribiendo actualmente (opcional)
}
```

**Prop√≥sito**: Representar cada mensaje del chat con toda su informaci√≥n asociada.

---

## üîß Variables de Estado del Componente

### Estado de Conexi√≥n
```typescript
isConnected: boolean = false;           // Si hay conexi√≥n activa con Azure
isConnecting: boolean = false;          // Si est√° en proceso de conexi√≥n
connectionStatusText: string = 'Desconectado'; // Texto del estado de conexi√≥n
```

### WebSocket
```typescript
private ws: WebSocket | null = null;    // Instancia de WebSocket
private wsUrl: string = '';             // URL completa del WebSocket
```

### Mensajes
```typescript
messages: ChatMessage[] = [];           // Array de mensajes del chat
messageText: string = '';               // Texto del input del usuario
isAssistantThinking: boolean = false;   // Si el asistente est√° procesando
```

### Audio y Grabaci√≥n
```typescript
isRecording: boolean = false;           // Si est√° grabando (legacy)
isMuted: boolean = false;               // Si el micr√≥fono est√° silenciado
isListeningMode: boolean = false;       // Si est√° en modo escucha continua
recordingDuration: number = 0;          // Duraci√≥n en segundos de la grabaci√≥n
private recordingInterval: any = null;  // Interval para contar segundos
private audioContext: AudioContext | null = null;      // Contexto de audio Web Audio API
private audioStream: MediaStream | null = null;        // Stream del micr√≥fono
private audioWorkletNode: AudioWorkletNode | null = null; // Nodo procesador de audio
private hasAudioBeenSent: boolean = false; // Flag para validar si se envi√≥ audio
```

### VAD (Voice Activity Detection)
```typescript
vadActive: boolean = false;             // Si el VAD detect√≥ habla
private vadAnalyser: AnalyserNode | null = null;       // Analizador de audio (unused)
private vadCheckInterval: any = null;   // Interval para chequeo VAD (unused)
private vadThreshold: number = -50;     // Umbral en dB para detectar voz (unused)
```
**Nota**: El VAD se maneja del lado del servidor (server_vad), las variables locales est√°n presentes pero no se usan.

### Control de Reproducci√≥n
```typescript
isAssistantSpeaking: boolean = false;   // Si el asistente est√° "hablando" (procesando respuesta)
isPlayingAudio: boolean = false;        // Si hay audio reproduci√©ndose
currentPlayingMessageId: string | null = null; // ID del mensaje que se est√° reproduciendo
private currentAudioSource: AudioBufferSourceNode | null = null; // Fuente de audio actual
```

### Mapeo de Audio y Tracking
```typescript
private audioBuffersByMessage: Map<string, string[]> = new Map(); // Buffers de audio por mensaje
private currentResponseId: string | null = null;         // ID de la respuesta actual
private currentAssistantMessageId: string | null = null; // ID del mensaje del asistente actual
private currentUserMessageId: string | null = null;      // ID del mensaje del usuario actual
```

### Sistema de Ping-Pong y Reconexi√≥n
```typescript
private pingInterval: any = null;                // Interval para enviar pings peri√≥dicos
private pongTimeout: any = null;                 // Timeout para esperar pong
private readonly PING_INTERVAL_MS = 25000;      // Ping cada 25 segundos
private readonly PONG_TIMEOUT_MS = 10000;       // Esperar pong m√°ximo 10 segundos
private reconnectAttempts: number = 0;           // Contador de intentos de reconexi√≥n
private readonly MAX_RECONNECT_ATTEMPTS = 5;    // M√°ximo 5 intentos de reconexi√≥n
private isReconnecting: boolean = false;         // Si est√° en proceso de reconexi√≥n
connectionLatency: number | null = null;         // Latencia en ms (p√∫blico para UI)
private lastPingTime: number = 0;                // Timestamp del √∫ltimo ping enviado
```

**Prop√≥sito**: Mantener la conexi√≥n WebSocket activa y detectar desconexiones tempranamente. Implementa reconexi√≥n autom√°tica con backoff exponencial.

---

## üîÑ Ciclo de Vida del Componente

### `ngOnInit()`
Se ejecuta al inicializar el componente:
1. Llama a `connectToRealtime()` para establecer la conexi√≥n WebSocket

### `ngAfterViewInit()`
Se ejecuta despu√©s de inicializar la vista:
1. Hace scroll al final del chat con un delay

### `ngOnDestroy()`
Se ejecuta al destruir el componente:
1. Llama a `stopPingPong()` para detener el sistema de ping-pong
2. Llama a `disconnect()` para cerrar el WebSocket
3. Llama a `stopListening()` para detener el micr√≥fono
4. Detiene todos los tracks del `audioStream`

---

## üåê Funciones de Conexi√≥n

### `connectToRealtime()`
Establece la conexi√≥n con Azure OpenAI Realtime API.

**Flujo**:
1. Cambia estado a `isConnecting = true`
2. Obtiene credenciales del backend: `GET /api/credentials/realtime`
3. Construye la URL del WebSocket:
   ```
   wss://<hostname>/openai/realtime?api-version=2025-08-28&deployment=<deployment>&api-key=<key>
   ```
   **Nota**: Usa la versi√≥n de API `2025-08-28` que es la m√°s reciente y estable (NO preview). La versi√≥n anterior `2024-10-01-preview` fue retirada.
4. Crea la conexi√≥n WebSocket
5. Configura event listeners:
   - `onopen`: Llama a `sendSessionConfig()` y `startPingPong()`
   - `onmessage`: Llama a `handleRealtimeMessage()`
   - `onerror`: Registra errores y actualiza estado
   - `onclose`: Actualiza estado de desconexi√≥n e intenta reconexi√≥n autom√°tica si no fue cierre intencional

**Manejo de Errores**: Captura excepciones y actualiza `connectionStatusText`

---

### `sendSessionConfig()`
Env√≠a la configuraci√≥n inicial de la sesi√≥n a Azure OpenAI.

**Configuraci√≥n Enviada**:
```json
{
  "type": "session.update",
  "session": {
    "modalities": ["text", "audio"],
    "instructions": "Eres un asistente √∫til y amigable...",
    "voice": "alloy",
    "input_audio_format": "pcm16",
    "output_audio_format": "pcm16",
    "input_audio_transcription": {
      "model": "whisper-1"
    },
    "turn_detection": {
      "type": "server_vad",
      "threshold": 0.5,
      "prefix_padding_ms": 300,
      "silence_duration_ms": 500
    }
  }
}
```

**Par√°metros Clave**:
- `deployment`: **gpt-realtime** (configurado en Azure, API version 2024-10-01-preview)
- `modalities`: Soporta texto y audio
- `voice`: Voz del asistente (alloy, echo, shimmer, etc.)
- `input_audio_format` / `output_audio_format`: PCM16 (16-bit PCM)
- `input_audio_transcription`: Usa Whisper para transcribir entrada
- `turn_detection`: VAD del servidor con umbral 0.5, silencio de 500ms

---

### `disconnect()`
Cierra la conexi√≥n WebSocket de forma segura.

**Flujo**:
1. Detiene el sistema de ping-pong con `stopPingPong()`
2. Cierra el WebSocket si existe
3. Resetea la variable `ws` a null
4. Limpia `connectionLatency`

---

## üèì Sistema de Ping-Pong y Reconexi√≥n Autom√°tica

### `startPingPong()`
Inicia el sistema de ping-pong para mantener la conexi√≥n activa.

**Flujo**:
1. Detiene cualquier ping-pong anterior con `stopPingPong()`
2. Inicia un `setInterval` que ejecuta `sendPing()` cada 25 segundos
3. Registra en consola el inicio del sistema

**Prop√≥sito**: Prevenir timeouts de conexi√≥n por inactividad y detectar desconexiones tempranamente.

---

### `stopPingPong()`
Detiene el sistema de ping-pong.

**Flujo**:
1. Limpia el `pingInterval` si existe
2. Limpia el `pongTimeout` si existe
3. Registra en consola la detenci√≥n del sistema

---

### `sendPing()`
Env√≠a un mensaje ping al servidor para verificar conexi√≥n.

**Flujo**:
1. Valida que el WebSocket est√© abierto
2. Omite el ping si hay actividad activa (`isListeningMode` o `isPlayingAudio`)
3. Guarda el timestamp actual en `lastPingTime`
4. Env√≠a mensaje JSON: `{ type: 'ping' }`
5. Inicia un timeout de 10 segundos esperando el `pong`
6. Si no se recibe pong, llama a `handlePongTimeout()`

**Manejo de Errores**: Si falla el env√≠o, llama a `handlePongTimeout()`

---

### `handlePong()`
Procesa la respuesta pong del servidor.

**Flujo**:
1. Calcula latencia: `Date.now() - lastPingTime`
2. Actualiza `connectionLatency` (visible en UI)
3. Cancela el `pongTimeout`
4. Registra latencia en consola
5. Fuerza actualizaci√≥n de UI con `detectChanges()`

---

### `handlePongTimeout()`
Maneja el caso cuando no se recibe pong a tiempo.

**Flujo**:
1. Registra error en consola
2. Limpia el `pongTimeout`
3. Llama a `disconnect()` para cerrar conexi√≥n
4. Llama a `attemptReconnection()` para reintentar

**Indicador**: La conexi√≥n est√° inactiva o perdida.

---

### `attemptReconnection()`
Intenta reconectar autom√°ticamente con backoff exponencial.

**Flujo**:
1. Valida que no est√© reconectando y no haya excedido intentos m√°ximos (5)
2. Incrementa `reconnectAttempts`
3. Calcula delay con backoff exponencial: `2^attempts` segundos (m√°x 30s)
4. Actualiza `connectionStatusText` con intento actual
5. Espera el delay calculado
6. Llama a `connectToRealtime()`
7. Si falla, reintenta recursivamente hasta alcanzar el m√°ximo

**Backoff Exponencial**:
- Intento 1: 2 segundos
- Intento 2: 4 segundos
- Intento 3: 8 segundos
- Intento 4: 16 segundos
- Intento 5: 30 segundos (m√°ximo)

**Al Conectar**: Resetea `reconnectAttempts = 0` para futuras desconexiones.

---

## üì® Manejo de Mensajes WebSocket

### `handleRealtimeMessage(data: string)`
Procesa todos los mensajes recibidos del servidor OpenAI.

**Eventos Manejados**:

#### 1. `session.created` / `session.updated`
Confirmaci√≥n de configuraci√≥n de sesi√≥n.

#### 2. `response.created`
Se crea una nueva respuesta:
- Captura `response.id` en `currentResponseId`

#### 3. `response.output_item.added`
Se agrega un nuevo item de salida:
- Si es del asistente, llama a `createAssistantAudioMessage(itemId)`

#### 4. `conversation.item.created`
Se crea un nuevo item en la conversaci√≥n:
- Si es del asistente: `isAssistantThinking = true`
- Si es del usuario: llama a `createUserAudioMessage(itemId)`

#### 5. `conversation.item.input_audio_transcription.completed`
Transcripci√≥n del audio del usuario completada:
- Llama a `updateUserTranscription(itemId, transcript)`

#### 6. `response.audio_transcript.delta`
Fragmento de transcripci√≥n del audio de respuesta:
- Llama a `updateAssistantTranscription(delta)`

#### 7. `response.audio_transcript.done`
Transcripci√≥n del audio completada:
- Llama a `finalizeAssistantTranscription()`

#### 8. `response.text.delta` / `response.text.done`
Fragmentos o texto completo de respuesta:
- Llama a `appendAssistantMessage()` o `addAssistantMessage()`

#### 9. `response.audio.delta`
Fragmento de audio de respuesta:
- Llama a `storeAudioDelta(delta)` para almacenar

#### 10. `response.audio.done`
Audio completo recibido:
- Llama a `finalizeAudioMessage()` para convertir y reproducir

#### 11. `response.done`
Respuesta completamente procesada:
- Extrae tokens con `updateMessageTokens(usage)`
- Resetea `currentResponseId`
- Limpia `currentAssistantMessageId` despu√©s de 100ms

#### 12. `input_audio_buffer.speech_started`
VAD detect√≥ inicio de habla:
- `vadActive = true`

#### 13. `input_audio_buffer.speech_stopped`
VAD detect√≥ fin de habla:
- `vadActive = false`

#### 14. `pong`
Respuesta del servidor al ping:
- Llama a `handlePong()` para calcular latencia
- Cancela timeout de desconexi√≥n

#### 15. `error`
Error del servidor:
- Registra error en consola
- `isAssistantThinking = false`

---

## üí¨ Funciones de Mensajer√≠a de Texto

### `sendTextMessage()`
Env√≠a un mensaje de texto al asistente.

**Flujo**:
1. Valida que hay texto, conexi√≥n y WebSocket abierto
2. Agrega mensaje del usuario a la UI con `addUserMessage()`
3. Env√≠a evento `conversation.item.create` al servidor:
   ```json
   {
     "type": "conversation.item.create",
     "item": {
       "type": "message",
       "role": "user",
       "content": [{"type": "input_text", "text": "..."}]
     }
   }
   ```
4. Solicita respuesta con `response.create`
5. Limpia input y activa `isAssistantThinking`

### `addUserMessage(content, type)`
Agrega un mensaje del usuario a la UI.

**Par√°metros**:
- `content`: Texto del mensaje
- `type`: 'text' o 'audio'

**Flujo**:
1. Crea objeto `ChatMessage` con ID temporal
2. Agrega al array `messages`
3. Hace scroll al final del chat

### `addAssistantMessage(content)`
Agrega un mensaje del asistente a la UI.

### `appendAssistantMessage(delta)`
Agrega texto incremental al √∫ltimo mensaje del asistente.

---

## üé§ Funciones de Audio en Tiempo Real

### `startListening()`
Inicia el modo de escucha continua con streaming de audio.

**Flujo**:
1. Valida conexi√≥n y que no est√© en modo escucha o asistente hablando
2. Solicita acceso al micr√≥fono con `getUserMedia()`:
   - `echoCancellation: true`
   - `noiseSuppression: true`
   - `sampleRate: 24000` (24kHz)
   - `channelCount: 1` (mono)
3. Crea `AudioContext` a 24kHz
4. Crea fuente de audio desde el stream
5. Agrega `AudioWorklet` con c√≥digo del procesador
6. Conecta: `source ‚Üí audioWorkletNode ‚Üí destination`
7. Configura listener `port.onmessage` para recibir buffers de audio
8. En cada mensaje:
   - Convierte Float32 a PCM16 con `floatToPCM16()`
   - Convierte a Base64 con `arrayBufferToBase64()`
   - Env√≠a al servidor: `input_audio_buffer.append`
   - Marca `hasAudioBeenSent = true` en el primer env√≠o
9. Activa `isListeningMode = true`
10. Inicia contador de duraci√≥n

**AudioWorklet Processor**:
- Buffer de 4800 samples (200ms a 24kHz)
- Acumula samples hasta llenar el buffer
- Env√≠a buffer completo al thread principal

### `floatToPCM16(float32Array)`
Convierte audio Float32 [-1, 1] a PCM16 [-32768, 32767].

**Algoritmo**:
```typescript
const s = Math.max(-1, Math.min(1, sample)); // Clamp
pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
```

### `arrayBufferToBase64(buffer)`
Convierte ArrayBuffer a string Base64 para transmisi√≥n.

---

### `toggleMute()`
Alterna entre silenciado y activo.

**Efecto**:
- Cambia `isMuted`
- Cuando est√° silenciado, el listener en `AudioWorklet.onmessage` no env√≠a audio al servidor

---

### `stopListening()`
Detiene el modo de escucha continua.

**Flujo**:
1. Valida que est√© en modo escucha
2. Silencia inmediatamente: `isMuted = true`
3. Desconecta y limpia `audioWorkletNode`
4. Detiene todos los tracks del `audioStream`
5. Cierra el `audioContext`
6. Detiene el `recordingInterval`
7. Resetea estados: `isListeningMode`, `isMuted`, `recordingDuration`
8. **NO detiene la reproducci√≥n de audio del asistente**
9. Valida estado del buffer:
   - Si `hasAudioBeenSent && vadActive`: Hace `commit` y solicita respuesta
   - Sino: Solo hace `clear` del buffer

**Importante**: El VAD debe estar activo para confirmar que hubo habla real y evitar el error `input_audio_buffer_commit_empty`.

---

## üéµ Funciones de Audio del Asistente

### `createAssistantAudioMessage(itemId)`
Crea un mensaje de audio del asistente en la UI.

**Flujo**:
1. Crea objeto `ChatMessage` con:
   - `id = itemId` (del servidor)
   - `type = 'audio'`
   - `isTranscribing = true`
   - `transcription = ''`
2. Agrega al array `messages`
3. Guarda `itemId` en `currentAssistantMessageId`
4. Inicializa array vac√≠o en `audioBuffersByMessage.set(itemId, [])`

### `storeAudioDelta(audioBase64)`
Almacena fragmentos de audio recibidos del servidor.

**Flujo**:
1. Valida que exista `currentAssistantMessageId`
2. Marca `isAssistantSpeaking = true` (pausa escucha)
3. Agrega el fragmento base64 al array en `audioBuffersByMessage`

### `finalizeAudioMessage()`
Finaliza el audio del asistente y lo reproduce autom√°ticamente.

**Flujo**:
1. Obtiene el mensaje y los buffers almacenados
2. Si hay buffers:
   - Convierte array de base64 a Blob con `base64ArrayToBlob()`
   - Asigna el blob al mensaje: `message.audioBlob = audioBlob`
   - Despu√©s de 100ms, llama a `playAudio(message)`
3. Si NO hay buffers:
   - Despu√©s de 500ms, reactiva escucha: `isAssistantSpeaking = false`

### `base64ArrayToBlob(base64Array)`
Convierte array de strings base64 a un Blob de audio PCM16.

**Algoritmo**:
1. Decodifica cada string base64 a binario
2. Calcula longitud total
3. Crea `Uint8Array` del tama√±o total
4. Copia todos los datos concatenados
5. Retorna `Blob` con tipo `audio/pcm`

---

### `playAudio(message)`
Reproduce el audio de un mensaje.

**Flujo**:
1. Valida que tenga `audioBlob` y no haya audio reproduci√©ndose
2. Marca estados:
   - `isPlayingAudio = true`
   - `isAssistantSpeaking = true`
   - `currentPlayingMessageId = message.id`
3. Crea `AudioContext` a 24kHz
4. Lee el blob con `FileReader`
5. Convierte PCM16 a `AudioBuffer` con `pcm16ToAudioBuffer()`
6. Crea `AudioBufferSourceNode`
7. Conecta: `source ‚Üí destination`
8. Configura `onended`:
   - Espera 500ms (anti-loop)
   - Resetea estados: `isPlayingAudio`, `isAssistantSpeaking`, `currentPlayingMessageId`, `vadActive`, `hasAudioBeenSent`
9. Inicia reproducci√≥n: `source.start(0)`

### `pcm16ToAudioBuffer(arrayBuffer, audioContext)`
Convierte ArrayBuffer PCM16 a AudioBuffer para reproducci√≥n.

**Algoritmo**:
1. Crea `Int16Array` del buffer
2. Crea `Float32Array` del mismo tama√±o
3. Normaliza: `float32[i] = int16[i] / 32768.0`
4. Crea `AudioBuffer` de 1 canal a 24kHz
5. Copia datos normalizados al buffer
6. Retorna `AudioBuffer`

---

### `stopAudio()`
Detiene la reproducci√≥n de audio manualmente.

**Flujo**:
1. Si hay `currentAudioSource`, lo detiene con `stop()`
2. Limpia `currentAudioSource`
3. Espera 500ms (anti-loop)
4. Resetea estados: `isPlayingAudio`, `isAssistantSpeaking`, `currentPlayingMessageId`, `vadActive`, `hasAudioBeenSent`

---

## üìù Funciones de Transcripci√≥n

### `createUserAudioMessage(itemId)`
Crea o actualiza el mensaje de audio del usuario.

**Flujo**:
1. Busca mensaje temporal del usuario (sin ID del servidor)
2. Si existe:
   - Actualiza `id` con el del servidor
   - Marca `isTranscribing = true`
   - Guarda en `currentUserMessageId`
3. Si NO existe:
   - Crea nuevo mensaje con `type = 'audio'`
   - `content = 'üé§ Mensaje de voz'`
   - `isTranscribing = true`

### `updateUserTranscription(itemId, transcript)`
Actualiza la transcripci√≥n del usuario cuando est√° completa.

**Flujo**:
1. Busca mensaje por `itemId`
2. Actualiza `transcription` y `content` con el texto
3. Marca `isTranscribing = false`

### `updateAssistantTranscription(delta)`
Agrega fragmentos de transcripci√≥n del asistente.

**Flujo**:
1. Valida `currentAssistantMessageId`
2. Busca mensaje
3. Inicializa `transcription` si no existe
4. Concatena el `delta`

### `finalizeAssistantTranscription()`
Finaliza la transcripci√≥n del asistente.

**Flujo**:
1. Busca mensaje por `currentAssistantMessageId`
2. Marca `isTranscribing = false`
3. Reemplaza `content` con la `transcription` completa

---

## ü™ô Funci√≥n de Tokens

### `updateMessageTokens(usage)`
Actualiza los tokens utilizados en los mensajes del usuario y asistente.

**Par√°metros del objeto `usage`**:
```typescript
{
  input_tokens: number,   // Tokens del usuario (entrada)
  output_tokens: number,  // Tokens del asistente (salida)
  total_tokens: number    // Total (input + output)
}
```

**Flujo**:
1. Extrae `inputTokens`, `outputTokens`, `totalTokens`
2. Si hay `currentUserMessageId` y `inputTokens > 0`:
   - Busca mensaje del usuario
   - Asigna `tokens = inputTokens`
3. Si hay `currentAssistantMessageId` y `outputTokens > 0`:
   - Busca mensaje del asistente
   - Asigna `tokens = outputTokens`
4. Recrea array de mensajes: `this.messages = [...this.messages]`
5. Fuerza 3 ciclos de detecci√≥n de cambios de Angular:
   - `markForCheck()` + `detectChanges()` inmediato
   - Otro en `setTimeout(0)`
   - Otro en `setTimeout(100)`

**Nota**: La recreaci√≥n del array y m√∫ltiples ciclos de detecci√≥n son necesarios para que Angular actualice la UI con los badges de tokens.

---

## üîÑ Diagrama de Ciclo de Vida de OpenAI Realtime API

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    INICIO DE CONEXI√ìN                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ   connectToRealtime   ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ GET /api/credentials  ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ WebSocket Connection (wss://) ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ    ws.onopen() ‚Üí      ‚îÇ
                  ‚îÇ  sendSessionConfig()  ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Env√≠a: session.update         ‚îÇ
              ‚îÇ - modalities: [text, audio]   ‚îÇ
              ‚îÇ - voice: alloy                ‚îÇ
              ‚îÇ - turn_detection: server_vad  ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Recibe: session.created       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                                                             ‚îÇ
‚ñº                                                             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ       FLUJO DE VOZ              ‚îÇ    ‚îÇ      FLUJO DE TEXTO              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ   startListening()    ‚îÇ              ‚îÇ   sendTextMessage()    ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚ñº
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
  ‚îÇ getUserMedia()        ‚îÇ              ‚îÇ conversation.item      ‚îÇ
  ‚îÇ - 24kHz, mono         ‚îÇ              ‚îÇ .create (type: text)   ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
  ‚îÇ AudioWorklet          ‚îÇ                           ‚îÇ
  ‚îÇ - Buffer: 4800        ‚îÇ                           ‚îÇ
  ‚îÇ - Float32 ‚Üí PCM16     ‚îÇ                           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
  ‚îÇ Streaming continuo:   ‚îÇ                           ‚îÇ
  ‚îÇ input_audio_buffer    ‚îÇ                           ‚îÇ
  ‚îÇ .append (cada 200ms)  ‚îÇ                           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
  ‚îÇ Server VAD detecta    ‚îÇ                           ‚îÇ
  ‚îÇ habla (threshold 0.5) ‚îÇ                           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
  ‚îÇ Eventos recibidos:    ‚îÇ                           ‚îÇ
  ‚îÇ - speech_started      ‚îÇ                           ‚îÇ
  ‚îÇ   (vadActive = true)  ‚îÇ                           ‚îÇ
  ‚îÇ - speech_stopped      ‚îÇ                           ‚îÇ
  ‚îÇ   (vadActive = false) ‚îÇ                           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
  ‚îÇ   stopListening()     ‚îÇ                           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
              ‚îÇ                                        ‚îÇ
              ‚ñº                                        ‚îÇ
  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
  ‚îÇ Si vadActive &&       ‚îÇ                           ‚îÇ
  ‚îÇ hasAudioBeenSent:     ‚îÇ                           ‚îÇ
  ‚îÇ - buffer.commit       ‚îÇ                           ‚îÇ
  ‚îÇ - response.create     ‚îÇ                           ‚îÇ
  ‚îÇ                       ‚îÇ                           ‚îÇ
  ‚îÇ Sino:                 ‚îÇ                           ‚îÇ
  ‚îÇ - buffer.clear        ‚îÇ                           ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                           ‚îÇ
              ‚îÇ                                        ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   PROCESAMIENTO DEL SERVIDOR  ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ Eventos recibidos:            ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 1. response.created           ‚îÇ
              ‚îÇ    (captura response.id)      ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 2. conversation.item.created  ‚îÇ
              ‚îÇ    - role: user               ‚îÇ
              ‚îÇ    ‚Üí createUserAudioMessage() ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 3. conversation.item          ‚îÇ
              ‚îÇ    .input_audio_transcription ‚îÇ
              ‚îÇ    .completed                 ‚îÇ
              ‚îÇ    ‚Üí updateUserTranscription()‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 4. response.output_item.added ‚îÇ
              ‚îÇ    - role: assistant          ‚îÇ
              ‚îÇ    ‚Üí createAssistantAudio     ‚îÇ
              ‚îÇ       Message()               ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 5. response.audio_transcript  ‚îÇ
              ‚îÇ    .delta                     ‚îÇ
              ‚îÇ    ‚Üí updateAssistant          ‚îÇ
              ‚îÇ       Transcription()         ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 6. response.audio_transcript  ‚îÇ
              ‚îÇ    .done                      ‚îÇ
              ‚îÇ    ‚Üí finalizeAssistant        ‚îÇ
              ‚îÇ       Transcription()         ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 7. response.audio.delta       ‚îÇ
              ‚îÇ    ‚Üí storeAudioDelta()        ‚îÇ
              ‚îÇ    (almacena fragmentos)      ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 8. response.audio.done        ‚îÇ
              ‚îÇ    ‚Üí finalizeAudioMessage()   ‚îÇ
              ‚îÇ    (convierte y reproduce)    ‚îÇ
              ‚îÇ                               ‚îÇ
              ‚îÇ 9. response.done              ‚îÇ
              ‚îÇ    ‚Üí updateMessageTokens()    ‚îÇ
              ‚îÇ    (input/output tokens)      ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   REPRODUCCI√ìN DE AUDIO       ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ base64ArrayToBlob()           ‚îÇ
              ‚îÇ ‚Üí Convierte fragmentos a Blob ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ playAudio()                   ‚îÇ
              ‚îÇ - isAssistantSpeaking = true  ‚îÇ
              ‚îÇ - currentPlayingMessageId set ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ pcm16ToAudioBuffer()          ‚îÇ
              ‚îÇ ‚Üí Convierte a AudioBuffer     ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ AudioBufferSourceNode.start() ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ source.onended ‚Üí              ‚îÇ
              ‚îÇ - Espera 500ms (anti-loop)    ‚îÇ
              ‚îÇ - isPlayingAudio = false      ‚îÇ
              ‚îÇ - isAssistantSpeaking = false ‚îÇ
              ‚îÇ - vadActive = false           ‚îÇ
              ‚îÇ - currentPlayingMessageId null‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   LISTO PARA NUEVA INTERACCI√ìN‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÄ Diagrama de Interacci√≥n: Audio ‚áÑ Texto

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              P√ÅGINA DEMO-REALTIME (Estado Inicial)              ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  [üé§ Micr√≥fono] [üìù Input de Texto] [üì§ Enviar]                ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ  isListeningMode = false                                        ‚îÇ
‚îÇ  isConnected = true                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  USUARIO PRESIONA   ‚îÇ                  ‚îÇ  USUARIO ESCRIBE     ‚îÇ
‚îÇ  BOT√ìN MICR√ìFONO üé§ ‚îÇ                  ‚îÇ  EN INPUT DE TEXTO   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                            ‚îÇ
‚îÇ startListening()    ‚îÇ                            ‚îÇ
‚îÇ - Solicita permiso  ‚îÇ                            ‚îÇ
‚îÇ - Crea AudioWorklet ‚îÇ                            ‚îÇ
‚îÇ - isListeningMode   ‚îÇ                            ‚îÇ
‚îÇ   = true            ‚îÇ                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                            ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ   UI CAMBIA A MODO VOZ:             ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ  [üî¥ MUTE] [‚èπÔ∏è STOP]                ‚îÇ            ‚îÇ
‚îÇ  Input de Texto: DESHABILITADO      ‚îÇ            ‚îÇ
‚îÇ  Bot√≥n Enviar: DESHABILITADO        ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ  Indicador:                          ‚îÇ            ‚îÇ
‚îÇ  üîµ Escuchando... 0s                 ‚îÇ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ STREAMING DE AUDIO EN TIEMPO REAL   ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ Cada 200ms (4800 samples):          ‚îÇ            ‚îÇ
‚îÇ - Float32 ‚Üí PCM16 ‚Üí Base64          ‚îÇ            ‚îÇ
‚îÇ - Env√≠a: input_audio_buffer.append  ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ Usuario puede:                       ‚îÇ            ‚îÇ
‚îÇ 1. Presionar MUTE (toggleMute)      ‚îÇ            ‚îÇ
‚îÇ    ‚Üí isMuted = !isMuted             ‚îÇ            ‚îÇ
‚îÇ    ‚Üí Se detiene env√≠o de audio      ‚îÇ            ‚îÇ
‚îÇ    ‚Üí Icono cambia: üî¥ ‚áÑ üü¢         ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ 2. Presionar STOP (stopListening)   ‚îÇ            ‚îÇ
‚îÇ    ‚Üí Ver flujo abajo                 ‚îÇ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ USUARIO PRESIONA STOP ‚èπÔ∏è            ‚îÇ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ stopListening()                     ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ 1. isMuted = true (silencia)        ‚îÇ            ‚îÇ
‚îÇ 2. Desconecta AudioWorklet          ‚îÇ            ‚îÇ
‚îÇ 3. Detiene stream del micr√≥fono     ‚îÇ            ‚îÇ
‚îÇ 4. Cierra AudioContext              ‚îÇ            ‚îÇ
‚îÇ 5. isListeningMode = false          ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ 6. Valida buffer:                   ‚îÇ            ‚îÇ
‚îÇ    Si vadActive && hasAudioBeenSent:‚îÇ            ‚îÇ
‚îÇ      ‚Üí buffer.commit                ‚îÇ            ‚îÇ
‚îÇ      ‚Üí response.create              ‚îÇ            ‚îÇ
‚îÇ    Sino:                             ‚îÇ            ‚îÇ
‚îÇ      ‚Üí buffer.clear (no commit)     ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ 7. NO detiene reproducci√≥n de audio ‚îÇ            ‚îÇ
‚îÇ    del asistente si est√° activa     ‚îÇ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ
         ‚îÇ                                          ‚îÇ
         ‚ñº                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ   UI REGRESA A MODO TEXTO:          ‚îÇ            ‚îÇ
‚îÇ                                      ‚îÇ            ‚îÇ
‚îÇ  [üé§ Micr√≥fono] [üìù Input] [üì§]    ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ  Input de Texto: HABILITADO         ‚îÇ
‚îÇ  Bot√≥n Enviar: HABILITADO           ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ  Usuario puede:                      ‚îÇ
‚îÇ  1. Escribir mensaje y enviar       ‚îÇ
‚îÇ     ‚Üí sendTextMessage()             ‚îÇ
‚îÇ  2. Presionar micr√≥fono de nuevo    ‚îÇ
‚îÇ     ‚Üí startListening()              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ RESPUESTA DEL ASISTENTE             ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ - Audio se reproduce autom√°ticamente‚îÇ
‚îÇ - Durante reproducci√≥n:              ‚îÇ
‚îÇ   * isAssistantSpeaking = true      ‚îÇ
‚îÇ   * No se puede iniciar escucha     ‚îÇ
‚îÇ   * startListening() est√° bloqueado ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ - Al terminar reproducci√≥n:          ‚îÇ
‚îÇ   * isAssistantSpeaking = false     ‚îÇ
‚îÇ   * Se puede volver a usar micr√≥fono‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéõÔ∏è Flujo Detallado: Mute y Stop

### BOT√ìN MUTE (Solo en modo escucha)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Estado: isListeningMode = true      ‚îÇ
‚îÇ         isMuted = false             ‚îÇ
‚îÇ         Audio streaming activo      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usuario presiona MUTE üî¥            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ toggleMute()                        ‚îÇ
‚îÇ ‚Üí isMuted = true                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Efecto:                             ‚îÇ
‚îÇ - AudioWorklet sigue capturando     ‚îÇ
‚îÇ - Listener en onmessage chequea:    ‚îÇ
‚îÇ   if (!isMuted && ...) {            ‚îÇ
‚îÇ     // env√≠a audio                  ‚îÇ
‚îÇ   }                                  ‚îÇ
‚îÇ - NO se env√≠a audio al servidor     ‚îÇ
‚îÇ - Icono cambia a üî¥                 ‚îÇ
‚îÇ - Color cambia a warning            ‚îÇ
‚îÇ - Indicador: "Silenciado"           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usuario presiona MUTE de nuevo      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ toggleMute()                        ‚îÇ
‚îÇ ‚Üí isMuted = false                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Efecto:                             ‚îÇ
‚îÇ - Listener vuelve a enviar audio    ‚îÇ
‚îÇ - Icono cambia a üü¢                 ‚îÇ
‚îÇ - Color cambia a success            ‚îÇ
‚îÇ - Indicador: "Escuchando..."        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### BOT√ìN STOP GENERAL (Solo en modo escucha)

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Estado: isListeningMode = true      ‚îÇ
‚îÇ         Audio streaming activo      ‚îÇ
‚îÇ         (puede estar en mute o no)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usuario presiona STOP ‚èπÔ∏è            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ stopListening()                     ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Paso 1: Detener captura de audio    ‚îÇ
‚îÇ - isMuted = true (silencia)         ‚îÇ
‚îÇ - audioWorkletNode.disconnect()     ‚îÇ
‚îÇ - audioStream.getTracks().stop()    ‚îÇ
‚îÇ - audioContext.close()              ‚îÇ
‚îÇ - clearInterval(recordingInterval)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Paso 2: Resetear estados            ‚îÇ
‚îÇ - isListeningMode = false           ‚îÇ
‚îÇ - isMuted = false                   ‚îÇ
‚îÇ - recordingDuration = 0             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Paso 3: Validar buffer de audio     ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ ¬øhasAudioBeenSent && vadActive?     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ         ‚îÇ
   S√ç        NO
    ‚îÇ         ‚îÇ
    ‚ñº         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇCOMMIT ‚îÇ ‚îÇ CLEAR  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ         ‚îÇ
    ‚ñº         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Env√≠a:  ‚îÇ ‚îÇ Env√≠a:       ‚îÇ
‚îÇ buffer  ‚îÇ ‚îÇ buffer.clear ‚îÇ
‚îÇ .commit ‚îÇ ‚îÇ              ‚îÇ
‚îÇ         ‚îÇ ‚îÇ (sin commit) ‚îÇ
‚îÇ response‚îÇ ‚îÇ              ‚îÇ
‚îÇ .create ‚îÇ ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Paso 4: UI regresa a modo texto     ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Botones visibles:                    ‚îÇ
‚îÇ - [üé§ Micr√≥fono] habilitado         ‚îÇ
‚îÇ - [üìù Input] habilitado             ‚îÇ
‚îÇ - [üì§ Enviar] habilitado            ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Indicador de escucha: OCULTO        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ IMPORTANTE:                          ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Si hay audio del asistente           ‚îÇ
‚îÇ reproduci√©ndose:                     ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ - isPlayingAudio = true              ‚îÇ
‚îÇ - currentPlayingMessageId != null   ‚îÇ
‚îÇ - Reproducci√≥n NO se detiene        ‚îÇ
‚îÇ - Audio sigue hasta terminar        ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Usuario puede:                       ‚îÇ
‚îÇ - Detener audio con bot√≥n Stop      ‚îÇ
‚îÇ   individual del mensaje             ‚îÇ
‚îÇ - Escribir texto mientras se         ‚îÇ
‚îÇ   reproduce                          ‚îÇ
‚îÇ - NO puede iniciar micr√≥fono hasta   ‚îÇ
‚îÇ   que termine el audio              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéÆ Controles de Reproducci√≥n Individual

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Mensaje de audio del asistente      ‚îÇ
‚îÇ con audioBlob disponible             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Estado inicial:                      ‚îÇ
‚îÇ - isPlayingAudio = false            ‚îÇ
‚îÇ - currentPlayingMessageId = null    ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ UI muestra:                          ‚îÇ
‚îÇ [‚ñ∂Ô∏è Reproducir] habilitado          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Usuario presiona [‚ñ∂Ô∏è Reproducir]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ playAudio(message)                  ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ - isPlayingAudio = true             ‚îÇ
‚îÇ - isAssistantSpeaking = true        ‚îÇ
‚îÇ - currentPlayingMessageId = msg.id  ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Convierte PCM16 ‚Üí AudioBuffer       ‚îÇ
‚îÇ Reproduce con AudioBufferSourceNode ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ UI de ESTE mensaje cambia a:        ‚îÇ
‚îÇ [‚èπÔ∏è Detener] habilitado             ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Otros mensajes con audio:            ‚îÇ
‚îÇ [‚ñ∂Ô∏è Reproducir] DESHABILITADO       ‚îÇ
‚îÇ (disabled=true porque isPlayingAudio‚îÇ
‚îÇ  est√° activo)                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ         ‚îÇ
 OPCI√ìN A  OPCI√ìN B
    ‚îÇ         ‚îÇ
    ‚ñº         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Audio   ‚îÇ ‚îÇ Usuario      ‚îÇ
‚îÇ termina ‚îÇ ‚îÇ presiona Stop‚îÇ
‚îÇ solo    ‚îÇ ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ         ‚îÇ
    ‚ñº         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇonended()‚îÇ ‚îÇ stopAudio()  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ         ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Espera 500ms (anti-loop)            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Resetea estados:                     ‚îÇ
‚îÇ - isPlayingAudio = false            ‚îÇ
‚îÇ - isAssistantSpeaking = false       ‚îÇ
‚îÇ - currentPlayingMessageId = null    ‚îÇ
‚îÇ - vadActive = false                 ‚îÇ
‚îÇ - hasAudioBeenSent = false          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ UI vuelve al estado inicial:        ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Todos los mensajes con audio:       ‚îÇ
‚îÇ [‚ñ∂Ô∏è Reproducir] habilitado          ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Bot√≥n micr√≥fono: habilitado         ‚îÇ
‚îÇ (si no hay isAssistantSpeaking)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üèì Diagrama del Sistema de Ping-Pong

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  SISTEMA DE PING-PONG ACTIVO                     ‚îÇ
‚îÇ                (Mantiene conexi√≥n WebSocket viva)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 Cada 25 segundos (PING_INTERVAL)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ¬øHay actividad activa?              ‚îÇ
‚îÇ (isListeningMode || isPlayingAudio) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                    ‚îÇ
    S√ç   ‚îÇ                    ‚îÇ  NO
         ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ OMITIR PING     ‚îÇ  ‚îÇ ENVIAR PING         ‚îÇ
‚îÇ (no interferir) ‚îÇ  ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ sendPing()                                                       ‚îÇ
‚îÇ 1. lastPingTime = Date.now()                                    ‚îÇ
‚îÇ 2. ws.send({ type: 'ping' })                                    ‚îÇ
‚îÇ 3. Inicia timeout de 10 segundos (PONG_TIMEOUT)                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ                               ‚îÇ
              ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   PONG RECIBIDO         ‚îÇ       ‚îÇ   TIMEOUT (10s)         ‚îÇ
‚îÇ   (antes de 10s)        ‚îÇ       ‚îÇ   (no hay pong)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                               ‚îÇ
              ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ handlePong()            ‚îÇ       ‚îÇ handlePongTimeout()     ‚îÇ
‚îÇ - Calcula latencia      ‚îÇ       ‚îÇ - Registra error        ‚îÇ
‚îÇ - Cancela timeout       ‚îÇ       ‚îÇ - disconnect()          ‚îÇ
‚îÇ - Actualiza UI          ‚îÇ       ‚îÇ - attemptReconnection() ‚îÇ
‚îÇ - connectionLatency     ‚îÇ       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ   visible               ‚îÇ                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                   ‚îÇ
              ‚îÇ                               ‚ñº
              ‚îÇ                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ                   ‚îÇ RECONEXI√ìN AUTOM√ÅTICA   ‚îÇ
              ‚îÇ                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              ‚îÇ                               ‚îÇ
              ‚ñº                               ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   CONEXI√ìN SALUDABLE                             ‚îÇ
‚îÇ              (Ping-Pong contin√∫a cada 25s)                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Reconexi√≥n Autom√°tica con Backoff Exponencial

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ DESCONEXI√ìN DETECTADA               ‚îÇ
‚îÇ (Error, Timeout, Cierre inesperado) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ¬øreconnectAttempts < 5?             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ           ‚îÇ
    NO   ‚îÇ           ‚îÇ  S√ç
         ‚ñº           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ FALLAR        ‚îÇ  ‚îÇ attemptReconnection()    ‚îÇ
‚îÇ "Reconexi√≥n   ‚îÇ  ‚îÇ                          ‚îÇ
‚îÇ  fallida"     ‚îÇ  ‚îÇ 1. reconnectAttempts++   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ 2. delay = 2^attempts s  ‚îÇ
                   ‚îÇ 3. Esperar delay         ‚îÇ
                   ‚îÇ 4. connectToRealtime()   ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ                           ‚îÇ
         √âXITO‚îÇ                           ‚îÇFALLO
              ‚ñº                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ CONECTADO                ‚îÇ  ‚îÇ Reintentar             ‚îÇ
‚îÇ - reconnectAttempts = 0  ‚îÇ  ‚îÇ (si attempts < 5)      ‚îÇ
‚îÇ - startPingPong()        ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ - connectionLatency null ‚îÇ              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îÇ
              ‚îÇ                           ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ  Backoff Exponencial:     ‚îÇ
              ‚îÇ  Intento 1: 2s            ‚îÇ
              ‚îÇ  Intento 2: 4s            ‚îÇ
              ‚îÇ  Intento 3: 8s            ‚îÇ
              ‚îÇ  Intento 4: 16s           ‚îÇ
              ‚îÇ  Intento 5: 30s (m√°x)     ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Herramientas de Desarrollo

### Angular Change Detection
Para actualizar tokens en la UI, se usa una estrategia agresiva:
1. Recrear array: `this.messages = [...this.messages]`
2. `cdr.markForCheck()` + `cdr.detectChanges()` (inmediato)
3. Repetir en `setTimeout(0)` y `setTimeout(100)`

Esto fuerza a Angular a detectar los cambios en objetos dentro del array.

---

## üìä Monitoreo y Logs

### Logs Esenciales Activos
- `console.log('üì¶ response.done completo:', message)` - Muestra objeto completo con usage
- `console.error('‚ùå Error del servidor:', message.error)` - Errores del servidor OpenAI
- `console.error('‚ùå Error WebSocket:', error)` - Errores de conexi√≥n
- `console.log('‚úÖ Conectado a Azure OpenAI Realtime API')` - Conexi√≥n exitosa
- `console.log('üîå Desconectado de Azure OpenAI Realtime API')` - Desconexi√≥n
- `console.log('üèì Sistema de ping-pong iniciado/detenido')` - Estado del ping-pong
- `console.log('üèì Ping enviado')` - Cada ping enviado
- `console.log('üèì Pong recibido - Latencia: Xms')` - Pong con latencia calculada
- `console.error('‚ùå No se recibi√≥ pong - conexi√≥n perdida')` - Timeout de pong
- `console.log('üîÑ Intento de reconexi√≥n X/5 en Yms')` - Intentos de reconexi√≥n

---

## üêõ Validaciones y Manejo de Errores

### Prevenci√≥n de `input_audio_buffer_commit_empty`
```typescript
if (this.hasAudioBeenSent && this.vadActive) {
  // Commit solo si hubo audio Y el VAD detect√≥ habla real
  this.ws.send(JSON.stringify({ type: 'input_audio_buffer.commit' }));
  this.ws.send(JSON.stringify({ type: 'response.create' }));
} else {
  // Solo limpiar buffer si no cumple las condiciones
  this.ws.send(JSON.stringify({ type: 'input_audio_buffer.clear' }));
}
```

### Anti-Loop en Reproducci√≥n
Delay de 500ms antes de resetear estados despu√©s de reproducci√≥n para evitar que el asistente se escuche a s√≠ mismo.

---

## üé® Estilos y UX

- **WhatsApp-style**: Mensajes del usuario a la derecha (color primary), asistente a la izquierda (color light)
- **Modo Oscuro**: Soportado nativamente por variables CSS de Ionic
- **Indicadores visuales**:
  - üü¢ Escuchando (success)
  - üî¥ Silenciado (warning)
  - ‚ö´ Asistente hablando (medium)
- **Badges de tokens**: Con icono ‚ö° flash
- **Botones disabled**: Input y enviar deshabilitados en modo voz

---

## üîê Seguridad

- API Key nunca expuesta en el cliente (se obtiene del backend)
- WebSocket con WSS (encrypted)
- Validaci√≥n de estados antes de acciones cr√≠ticas

---

## üìù Notas T√©cnicas

### Formato de Audio
- **Entrada**: PCM16 mono 24kHz
- **Salida**: PCM16 mono 24kHz
- **Streaming**: Buffers de 200ms (4800 samples)

### Transcripci√≥n
- **Modelo**: Whisper-1
- **En tiempo real**: Fragmentos incrementales con `.delta`, finalizado con `.done`

### VAD (Voice Activity Detection)
- **Tipo**: Server-side (OpenAI maneja detecci√≥n)
- **Threshold**: 0.5 (balance entre sensibilidad y falsos positivos)
- **Silence duration**: 500ms antes de considerar fin de habla

### Sistema de Ping-Pong
- **Intervalo de ping**: 25 segundos (mantiene conexi√≥n activa)
- **Timeout de pong**: 10 segundos (detecta desconexi√≥n)
- **Omite pings**: Durante streaming de audio o reproducci√≥n (evita interferencias)
- **Latencia**: Calculada y visible en UI (ms entre ping y pong)
- **Reconexi√≥n**: Autom√°tica con backoff exponencial (hasta 5 intentos)
- **Backoff**: 2, 4, 8, 16, 30 segundos progresivamente
- **API Version**: 2025-08-28 (estable)

---

## üöÄ Pr√≥ximas Mejoras Potenciales

1. **Persistencia**: Guardar conversaciones en localStorage o backend
2. ‚úÖ **Reconexi√≥n autom√°tica**: Sistema de ping-pong implementado con reconexi√≥n autom√°tica y backoff exponencial
3. **Configuraci√≥n de voz**: Permitir seleccionar entre diferentes voces (alloy, echo, shimmer)
4. **Historial de tokens**: Acumulado total de tokens por sesi√≥n
5. **Exportar conversaci√≥n**: Descargar chat como texto o JSON
6. **Soporte multi-idioma**: Detecci√≥n autom√°tica de idioma del usuario
7. **Compresi√≥n de audio**: Usar formato m√°s eficiente que PCM16
8. **Streaming de texto**: Mostrar texto del asistente mientras se genera (no solo audio)
9. **Indicador de latencia**: Mostrar latencia de conexi√≥n en UI con c√≥digo de colores
10. **M√©tricas de reconexi√≥n**: Dashboard de estad√≠sticas de conexi√≥n y reconexiones

---

## üìö Referencias

- [Azure OpenAI Realtime API Documentation](https://learn.microsoft.com/en-us/azure/ai-services/openai/realtime-audio-quickstart)
- [Azure OpenAI API Version Lifecycle](https://learn.microsoft.com/en-us/azure/ai-services/openai/api-version-deprecation)
- [Supported Models - gpt-realtime](https://learn.microsoft.com/en-us/azure/ai-foundry/openai/concepts/models#audio-models)
- [Web Audio API](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)
- [AudioWorklet](https://developer.mozilla.org/en-US/docs/Web/API/AudioWorklet)
- [Ionic Framework](https://ionicframework.com/docs)
- [Angular Change Detection](https://angular.dev/guide/signals)

---

**Autor**: Ezequiel Baltodano  
**Fecha**: 6 de octubre de 2025  
**Versi√≥n**: 1.0.0
