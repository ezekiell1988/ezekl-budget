<ion-header [translucent]="true">
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      @if (selectedExam) {
        <ion-button (click)="goBackToSelector()">
          <ion-icon name="arrow-back" slot="icon-only"></ion-icon>
        </ion-button>
      } @else {
        <ion-back-button defaultHref="/"></ion-back-button>
      }
    </ion-buttons>
    <ion-title>Repaso con Voz</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="handleRefresh($event)">
        <ion-icon name="refresh" slot="icon-only" color="light"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Selector de examen -->
  @if (!selectedExam) {
    <ion-toolbar>
      <ion-select
        placeholder="Selecciona un examen"
        (ionChange)="onExamSelected($event)"
        interface="popover"
        class="exam-selector">
        @for (pdf of availablePdfs; track pdf.id) {
          <ion-select-option [value]="pdf.id">
            {{ pdf.displayName }}
          </ion-select-option>
        }
      </ion-select>
    </ion-toolbar>
  }

  <!-- Barra de progreso con control de reproducción -->
  @if (selectedExam && initialLoadComplete) {
    <ion-toolbar color="light">
      <ion-grid class="ion-no-padding">
        <ion-row class="ion-align-items-center ion-padding-horizontal">
          <ion-col size="auto">
            <ion-button
              [color]="isSpeaking ? 'warning' : 'success'"
              size="default"
              fill="solid"
              shape="round"
              (click)="toggleSpeech()">
              <ion-icon [name]="isSpeaking ? 'pause' : 'play'" slot="icon-only"></ion-icon>
            </ion-button>
          </ion-col>
          <ion-col>
            <ion-text color="medium">
              <p class="ion-no-margin"><strong>{{ progressText }}</strong> ({{ progressPercent }}%)</p>
            </ion-text>
            <ion-progress-bar
              [value]="progressPercent / 100"
              [color]="progressPercent === 100 ? 'success' : 'primary'">
            </ion-progress-bar>
          </ion-col>
        </ion-row>
      </ion-grid>
    </ion-toolbar>
  }
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Sin examen seleccionado -->
  @if (!selectedExam) {
    <ion-grid class="ion-text-center ion-padding" style="height: 100%;">
      <ion-row class="ion-justify-content-center ion-align-items-center" style="height: 100%;">
        <ion-col size="12" sizeMd="8" sizeLg="6">
          <ion-icon name="mic-outline" size="large" color="medium" style="font-size: 64px;"></ion-icon>
          <h2>Selecciona un examen</h2>
          <ion-text color="medium">
            <p>Elige un examen del menú superior para comenzar tu repaso con voz</p>
          </ion-text>
        </ion-col>
      </ion-row>
    </ion-grid>
  }

  <!-- Loading -->
  @if (selectedExam && !initialLoadComplete) {
    <ion-card color="light">
      <ion-card-content>
        <ion-grid>
          <ion-row class="ion-align-items-center">
            <ion-col size="auto">
              <ion-icon name="mic" size="large" color="primary"></ion-icon>
            </ion-col>
            <ion-col>
              <h3 class="ion-no-margin">Cargando preguntas...</h3>
              <ion-text color="medium">
                <p class="ion-no-margin">Preparando lectura de voz</p>
              </ion-text>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Skeletons -->
    @for (item of [1,2,3,4,5]; track item) {
      <ion-card>
        <ion-card-header>
          <ion-skeleton-text [animated]="true" style="width: 30%; height: 24px;"></ion-skeleton-text>
        </ion-card-header>
        <ion-card-content>
          <ion-skeleton-text [animated]="true" style="width: 100%; height: 20px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 90%; height: 20px; margin-bottom: 8px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 95%; height: 20px;"></ion-skeleton-text>
          <ion-skeleton-text [animated]="true" style="width: 80%; height: 40px; margin-top: 16px;"></ion-skeleton-text>
        </ion-card-content>
      </ion-card>
    }
  }

  <!-- Vista de pregunta actual (para lector de voz) -->
  @if (selectedExam && initialLoadComplete && currentQuestion) {
    <ion-card>
      <ion-card-header>
        <ion-grid class="ion-no-padding">
          <ion-row class="ion-align-items-center ion-justify-content-between">
            <ion-col>
              <ion-chip [color]="isCompleted(currentQuestion.numberQuestion) ? 'success' : 'primary'">
                <ion-icon [name]="isCompleted(currentQuestion.numberQuestion) ? 'checkmark-circle' : 'radio-button-on'"></ion-icon>
                <ion-label><strong>Pregunta {{ currentQuestion.numberQuestion }} de {{ totalQuestions }}</strong></ion-label>
              </ion-chip>
            </ion-col>
            @if (isSpeaking) {
              <ion-col size="auto">
                <ion-chip color="warning">
                  <ion-icon name="volume-high"></ion-icon>
                  <ion-label>Reproduciendo</ion-label>
                </ion-chip>
              </ion-col>
            }
          </ion-row>
        </ion-grid>
      </ion-card-header>

      <ion-card-content>
        <ion-text>
          <h2>{{ currentQuestion.shortQuestion }}</h2>
        </ion-text>

        @if (currentQuestion.correctAnswer) {
          <ion-item color="success" lines="none" class="ion-margin-top">
            <ion-icon name="checkmark-circle" slot="start"></ion-icon>
            <ion-label class="ion-text-wrap">
              <h3>Respuesta Correcta</h3>
              <p>{{ currentQuestion.correctAnswer }}</p>
            </ion-label>
          </ion-item>
        }
      </ion-card-content>
    </ion-card>

    <!-- Lista completa de preguntas (siempre visible) -->
    <ion-card>
      <ion-card-header>
        <ion-grid class="ion-no-padding">
          <ion-row class="ion-align-items-center ion-justify-content-between">
            <ion-col>
              <ion-text color="primary">
                <h3 class="ion-no-margin">
                  <ion-icon name="list" style="vertical-align: middle;"></ion-icon>
                  Todas las Preguntas
                </h3>
              </ion-text>
            </ion-col>
            <ion-col size="auto">
              <ion-chip color="primary">
                <ion-label><strong>{{ progressText }}</strong></ion-label>
              </ion-chip>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-header>

      <ion-list>
        @for (question of questions; track question.numberQuestion) {
          <ion-item
            button
            [color]="question.numberQuestion === currentQuestionNumber ? 'light' : undefined"
            (click)="goToQuestion(question.numberQuestion)">
            <ion-chip
              slot="start"
              [color]="isCompleted(question.numberQuestion) ? 'success' : 'medium'"
              size="small">
              <ion-label>{{ question.numberQuestion }}</ion-label>
            </ion-chip>
            <ion-label class="ion-text-wrap">
              <p>{{ question.shortQuestion | slice:0:80 }}{{ question.shortQuestion.length > 80 ? '...' : '' }}</p>
            </ion-label>
            @if (isCompleted(question.numberQuestion)) {
              <ion-icon name="checkmark-circle" color="success" slot="end"></ion-icon>
            }
          </ion-item>
        }
      </ion-list>
    </ion-card>
  }

  <!-- Sin preguntas -->
  @if (selectedExam && initialLoadComplete && questions.length === 0) {
    <ion-grid class="ion-text-center ion-padding">
      <ion-row class="ion-justify-content-center">
        <ion-col size="12" sizeMd="8" sizeLg="6">
          <ion-icon name="alert-circle" size="large" color="warning" style="font-size: 64px;"></ion-icon>
          <h3>No hay preguntas</h3>
          <ion-text color="medium">
            <p>No se encontraron preguntas para este examen</p>
          </ion-text>
        </ion-col>
      </ion-row>
    </ion-grid>
  }

  <!-- FAB de acciones (top-right) -->
  @if (selectedExam && initialLoadComplete && questions.length > 0) {
    <ion-fab vertical="top" horizontal="end" slot="fixed">
      <ion-fab-button color="secondary">
        <ion-icon name="ellipsis-vertical"></ion-icon>
      </ion-fab-button>

      <ion-fab-list side="bottom">
        <ion-fab-button
          color="tertiary"
          (click)="openGoToDialog()">
          <ion-icon name="navigate"></ion-icon>
        </ion-fab-button>

        <ion-fab-button
          color="success"
          (click)="markAllPreviousComplete()"
          [disabled]="currentQuestionNumber <= 0">
          <ion-icon name="checkmark-done"></ion-icon>
        </ion-fab-button>
      </ion-fab-list>
    </ion-fab>

    <!-- FAB de navegación: Anterior (izquierda) -->
    <ion-fab vertical="bottom" horizontal="start" slot="fixed">
      <ion-fab-button
        color="secondary"
        (click)="goToPreviousQuestion()"
        [disabled]="currentQuestionNumber <= 1">
        <ion-icon name="chevron-up"></ion-icon>
      </ion-fab-button>
    </ion-fab>

    <!-- FAB de navegación: Siguiente (derecha) -->
    <ion-fab vertical="bottom" horizontal="end" slot="fixed">
      <ion-fab-button
        color="secondary"
        (click)="goToNextQuestion()"
        [disabled]="currentQuestionNumber >= totalQuestions">
        <ion-icon name="chevron-down"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  }
</ion-content>
