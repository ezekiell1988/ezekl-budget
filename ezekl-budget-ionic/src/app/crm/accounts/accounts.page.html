<app-header
  title="Cuentas"
  [showMenu]="true"
  [showActions]="true"
  [showSearch]="true"
  searchPlaceholder="Buscar cuentas por nombre..."
  (searchChange)="onHeaderSearch($event)"
  (searchToggle)="onHeaderSearchToggle($event)">
</app-header>

<ion-content>

  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pulling-text="Desliza para actualizar"
      refreshing-text="Actualizando cuentas...">
    </ion-refresher-content>
  </ion-refresher>

  <ion-grid fixed>

  <!-- Lista de cuentas -->
  @if (!isLoading || accounts.length > 0) {
  <div>

    <!-- Cuentas encontradas -->
    @if (accounts.length > 0) {
    <ion-list>
      @for (account of accounts; track account.accountid) {
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ account.name }}</ion-card-title>

          <!-- Información básica -->
          <div style="margin-top: 8px; font-size: 0.9rem; color: var(--ion-color-medium);">
            @if (account.accountnumber) {
              <ion-note>Cuenta #{{ account.accountnumber }}</ion-note>
            }
          </div>
        </ion-card-header>

        <ion-card-content>
          <!-- Información de contacto -->
          @if (account.telephone1 || account.emailaddress1 || account.websiteurl) {
          <div style="margin-bottom: 12px;">
            <ion-text color="medium" style="font-size: 0.85rem; font-weight: 600;">
              Contacto:
            </ion-text>

            @if (account.telephone1) {
            <div style="margin-top: 4px; display: flex; align-items: center; gap: 8px;">
              <ion-icon name="call-outline" color="medium" style="font-size: 1rem;"></ion-icon>
              <span style="font-size: 0.9rem;">{{ account.telephone1 }}</span>
            </div>
            }

            @if (account.emailaddress1) {
            <div style="margin-top: 4px; display: flex; align-items: center; gap: 8px;">
              <ion-icon name="mail-outline" color="medium" style="font-size: 1rem;"></ion-icon>
              <span style="font-size: 0.9rem;">{{ account.emailaddress1 }}</span>
            </div>
            }

            @if (account.websiteurl) {
            <div style="margin-top: 4px; display: flex; align-items: center; gap: 8px;">
              <ion-icon name="globe-outline" color="medium" style="font-size: 1rem;"></ion-icon>
              <span style="font-size: 0.9rem;">{{ account.websiteurl }}</span>
            </div>
            }
          </div>
          }

          <!-- Dirección -->
          @if (account.address1_city || account.address1_country) {
          <div style="margin-bottom: 12px;">
            <ion-text color="medium" style="font-size: 0.85rem; font-weight: 600;">
              Ubicación:
            </ion-text>
            <div style="margin-top: 4px; display: flex; align-items: center; gap: 8px;">
              <ion-icon name="location-outline" color="medium" style="font-size: 1rem;"></ion-icon>
              <span style="font-size: 0.9rem;">
                {{ account.address1_city }}@if (account.address1_city && account.address1_country) {, } {{ account.address1_country }}
              </span>
            </div>
          </div>
          }

          <!-- Fechas -->
          <div style="margin-bottom: 12px;">
            <ion-text color="medium" style="font-size: 0.85rem;">
              Creado: {{ formatDate(account.createdon) }}
            </ion-text>
          </div>

          <!-- Acciones -->
          <div style="display: flex; gap: 8px; margin-top: 16px;">
            <ion-button size="small" fill="outline" (click)="openViewModal(account)">
              <ion-icon slot="start" name="eye-outline"></ion-icon>
              Ver
            </ion-button>

            <ion-button size="small" fill="outline" color="primary" (click)="openEditModal(account)">
              <ion-icon slot="start" name="create-outline"></ion-icon>
              Editar
            </ion-button>

            <ion-button size="small" fill="outline" color="danger" (click)="deleteAccount(account)">
              <ion-icon slot="start" name="trash-outline"></ion-icon>
              Eliminar
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
      }
    </ion-list>

    <!-- Infinite scroll -->
    <ion-infinite-scroll (ionInfinite)="onLoadMore($event)" [disabled]="!hasNextPage">
      <ion-infinite-scroll-content loading-text="Cargando más cuentas...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
    }

  </div>
  }

  <!-- Estado de carga inicial - Skeleton -->
  @if (isLoading && accounts.length === 0) {
  <ion-list class="ion-padding">
    @for (item of [1,2,3,4,5]; track item) {
    <ion-card>
      <ion-card-header>
        <ion-skeleton-text animated style="width: 70%; height: 24px; margin-bottom: 8px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 40%; height: 16px;"></ion-skeleton-text>
      </ion-card-header>
      <ion-card-content>
        <ion-skeleton-text animated style="width: 100%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 90%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width: 80%; height: 16px; margin-bottom: 16px;"></ion-skeleton-text>

        <div style="display: flex; gap: 8px;">
          <ion-skeleton-text animated style="width: 80px; height: 32px; border-radius: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 80px; height: 32px; border-radius: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 100px; height: 32px; border-radius: 8px;"></ion-skeleton-text>
        </div>
      </ion-card-content>
    </ion-card>
    }
  </ion-list>
  }

  <!-- Estado vacío -->
  @if (!isLoading && accounts.length === 0) {
  <div class="ion-padding ion-text-center" style="margin-top: 64px;">
    <ion-icon name="business-outline" size="large" color="medium"></ion-icon>
    <h3 class="ion-margin-top" style="color: var(--ion-color-medium);">No hay cuentas</h3>
    <p class="ion-margin-bottom" style="color: var(--ion-color-medium);">
      No se encontraron cuentas que coincidan con los filtros aplicados.
    </p>
    <ion-button fill="outline" (click)="clearFilters()">
      <ion-icon name="filter-outline" slot="start"></ion-icon>
      Limpiar Filtros
    </ion-button>
  </div>
  }
  </ion-grid>

  <!-- Botón flotante para agregar cuenta -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openCreateModal()" [disabled]="isLoading">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>

<!-- MODAL CREAR CUENTA -->
<ion-modal [isOpen]="isCreateModalOpen" (willDismiss)="closeCreateModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Crear Nueva Cuenta</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCreateModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form [formGroup]="createForm" (ngSubmit)="createAccount()">

        <!-- Nombre (requerido) -->
        <ion-item>
          <ion-input
            label="Nombre de la Cuenta *"
            labelPlacement="floating"
            formControlName="name"
            placeholder="Ej: Acme Corporation"
            [counter]="true"
            maxlength="160">
          </ion-input>
        </ion-item>
        @if (createForm.get('name')?.invalid && createForm.get('name')?.touched) {
          <ion-text color="danger" style="font-size: 0.85rem; padding-left: 16px;">
            <p>El nombre es requerido (1-160 caracteres)</p>
          </ion-text>
        }

        <!-- Número de cuenta -->
        <ion-item>
          <ion-input
            label="Número de Cuenta"
            labelPlacement="floating"
            formControlName="accountnumber"
            placeholder="Ej: ACC-001">
          </ion-input>
        </ion-item>

        <!-- Teléfono -->
        <ion-item>
          <ion-input
            label="Teléfono"
            labelPlacement="floating"
            formControlName="telephone1"
            type="tel"
            placeholder="Ej: +34 912 345 678">
          </ion-input>
        </ion-item>

        <!-- Email -->
        <ion-item>
          <ion-input
            label="Email"
            labelPlacement="floating"
            formControlName="emailaddress1"
            type="email"
            placeholder="Ej: contacto@empresa.com">
          </ion-input>
        </ion-item>
        @if (createForm.get('emailaddress1')?.invalid && createForm.get('emailaddress1')?.touched) {
          <ion-text color="danger" style="font-size: 0.85rem; padding-left: 16px;">
            <p>Email inválido</p>
          </ion-text>
        }

        <!-- Sitio web -->
        <ion-item>
          <ion-input
            label="Sitio Web"
            labelPlacement="floating"
            formControlName="websiteurl"
            type="url"
            placeholder="Ej: https://www.empresa.com">
          </ion-input>
        </ion-item>

        <!-- Dirección línea 1 -->
        <ion-item>
          <ion-input
            label="Dirección"
            labelPlacement="floating"
            formControlName="address1_line1"
            placeholder="Ej: Calle Principal 123">
          </ion-input>
        </ion-item>

        <!-- Ciudad -->
        <ion-item>
          <ion-input
            label="Ciudad"
            labelPlacement="floating"
            formControlName="address1_city"
            placeholder="Ej: Madrid">
          </ion-input>
        </ion-item>

        <!-- Código postal -->
        <ion-item>
          <ion-input
            label="Código Postal"
            labelPlacement="floating"
            formControlName="address1_postalcode"
            placeholder="Ej: 28001">
          </ion-input>
        </ion-item>

        <!-- País -->
        <ion-item>
          <ion-input
            label="País"
            labelPlacement="floating"
            formControlName="address1_country"
            placeholder="Ej: España">
          </ion-input>
        </ion-item>

        <!-- Botones -->
        <div style="margin-top: 24px; display: flex; gap: 12px;">
          <ion-button expand="block" type="submit" [disabled]="createForm.invalid || isLoading">
            <ion-icon name="checkmark-outline" slot="start"></ion-icon>
            Crear Cuenta
          </ion-button>

          <ion-button expand="block" fill="outline" (click)="closeCreateModal()" [disabled]="isLoading">
            Cancelar
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- MODAL EDITAR CUENTA -->
<ion-modal [isOpen]="isEditModalOpen" (willDismiss)="closeEditModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Editar Cuenta</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeEditModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form [formGroup]="editForm" (ngSubmit)="updateAccount()">

        <!-- Nombre (requerido) -->
        <ion-item>
          <ion-input
            label="Nombre de la Cuenta *"
            labelPlacement="floating"
            formControlName="name"
            placeholder="Ej: Acme Corporation"
            [counter]="true"
            maxlength="160">
          </ion-input>
        </ion-item>
        @if (editForm.get('name')?.invalid && editForm.get('name')?.touched) {
          <ion-text color="danger" style="font-size: 0.85rem; padding-left: 16px;">
            <p>El nombre es requerido (1-160 caracteres)</p>
          </ion-text>
        }

        <!-- Número de cuenta -->
        <ion-item>
          <ion-input
            label="Número de Cuenta"
            labelPlacement="floating"
            formControlName="accountnumber"
            placeholder="Ej: ACC-001">
          </ion-input>
        </ion-item>

        <!-- Teléfono -->
        <ion-item>
          <ion-input
            label="Teléfono"
            labelPlacement="floating"
            formControlName="telephone1"
            type="tel"
            placeholder="Ej: +34 912 345 678">
          </ion-input>
        </ion-item>

        <!-- Email -->
        <ion-item>
          <ion-input
            label="Email"
            labelPlacement="floating"
            formControlName="emailaddress1"
            type="email"
            placeholder="Ej: contacto@empresa.com">
          </ion-input>
        </ion-item>
        @if (editForm.get('emailaddress1')?.invalid && editForm.get('emailaddress1')?.touched) {
          <ion-text color="danger" style="font-size: 0.85rem; padding-left: 16px;">
            <p>Email inválido</p>
          </ion-text>
        }

        <!-- Sitio web -->
        <ion-item>
          <ion-input
            label="Sitio Web"
            labelPlacement="floating"
            formControlName="websiteurl"
            type="url"
            placeholder="Ej: https://www.empresa.com">
          </ion-input>
        </ion-item>

        <!-- Dirección línea 1 -->
        <ion-item>
          <ion-input
            label="Dirección"
            labelPlacement="floating"
            formControlName="address1_line1"
            placeholder="Ej: Calle Principal 123">
          </ion-input>
        </ion-item>

        <!-- Ciudad -->
        <ion-item>
          <ion-input
            label="Ciudad"
            labelPlacement="floating"
            formControlName="address1_city"
            placeholder="Ej: Madrid">
          </ion-input>
        </ion-item>

        <!-- Código postal -->
        <ion-item>
          <ion-input
            label="Código Postal"
            labelPlacement="floating"
            formControlName="address1_postalcode"
            placeholder="Ej: 28001">
          </ion-input>
        </ion-item>

        <!-- País -->
        <ion-item>
          <ion-input
            label="País"
            labelPlacement="floating"
            formControlName="address1_country"
            placeholder="Ej: España">
          </ion-input>
        </ion-item>

        <!-- Botones -->
        <div style="margin-top: 24px; display: flex; gap: 12px;">
          <ion-button expand="block" type="submit" [disabled]="editForm.invalid || isLoading">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Actualizar Cuenta
          </ion-button>

          <ion-button expand="block" fill="outline" (click)="closeEditModal()" [disabled]="isLoading">
            Cancelar
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- MODAL VER CUENTA -->
<ion-modal [isOpen]="isViewModalOpen" (willDismiss)="closeViewModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Detalles de la Cuenta</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeViewModal()">
            <ion-icon name="close" slot="icon-only"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    @if (selectedAccount) {
    <ion-content class="ion-padding">
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ selectedAccount.name }}</ion-card-title>
          @if (selectedAccount.accountnumber) {
            <ion-note>Cuenta #{{ selectedAccount.accountnumber }}</ion-note>
          }
        </ion-card-header>

        <ion-card-content>
          <!-- Información de contacto -->
          <div style="margin-bottom: 16px;">
            <ion-text color="primary" style="font-weight: 600;">
              <h3>Información de Contacto</h3>
            </ion-text>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Teléfono</p>
                <h3>{{ selectedAccount.telephone1 || '(No especificado)' }}</h3>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Email</p>
                <h3>{{ selectedAccount.emailaddress1 || '(No especificado)' }}</h3>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Sitio Web</p>
                <h3>{{ selectedAccount.websiteurl || '(No especificado)' }}</h3>
              </ion-label>
            </ion-item>
          </div>

          <!-- Dirección -->
          <div style="margin-bottom: 16px;">
            <ion-text color="primary" style="font-weight: 600;">
              <h3>Dirección</h3>
            </ion-text>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Calle</p>
                <h3>{{ selectedAccount.address1_line1 || '(No especificado)' }}</h3>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Ciudad</p>
                <h3>{{ selectedAccount.address1_city || '(No especificado)' }}</h3>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Código Postal</p>
                <h3>{{ selectedAccount.address1_postalcode || '(No especificado)' }}</h3>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">País</p>
                <h3>{{ selectedAccount.address1_country || '(No especificado)' }}</h3>
              </ion-label>
            </ion-item>
          </div>

          <!-- Fechas del sistema -->
          <div>
            <ion-text color="primary" style="font-weight: 600;">
              <h3>Información del Sistema</h3>
            </ion-text>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Fecha de Creación</p>
                <h3>{{ formatDate(selectedAccount.createdon) }}</h3>
              </ion-label>
            </ion-item>

            <ion-item lines="none">
              <ion-label>
                <p style="color: var(--ion-color-medium); font-size: 0.85rem;">Última Modificación</p>
                <h3>{{ formatDate(selectedAccount.modifiedon) }}</h3>
              </ion-label>
            </ion-item>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-content>
    }
  </ng-template>
</ion-modal>
