<app-header
  title="Casos"
  [showMenu]="true"
  [showActions]="true"
  [showSearch]="true"
  searchPlaceholder="Buscar casos por título..."
  (searchChange)="onHeaderSearch($event)"
  (searchToggle)="onHeaderSearchToggle($event)">
</app-header>

<ion-content>

  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pulling-text="Desliza para actualizar"
      refreshing-text="Actualizando casos...">
    </ion-refresher-content>
  </ion-refresher>

  <ion-grid fixed>
    <!-- Filtro de estado -->
    <ion-item lines="none" class="ion-margin-bottom">
      <ion-label>Estado:</ion-label>
      <ion-select
        [(ngModel)]="selectedStatus"
        (ionChange)="onStatusFilter($event)"
        placeholder="Todos los estados"
        interface="popover">
        <ion-select-option [value]="null">Todos los estados</ion-select-option>
        <ion-select-option [value]="CaseStatus.Active">Activo</ion-select-option>
        <ion-select-option [value]="CaseStatus.Resolved">Resuelto</ion-select-option>
        <ion-select-option [value]="CaseStatus.Canceled">Cancelado</ion-select-option>
      </ion-select>
    </ion-item>

  <!-- Lista de casos -->
  @if (!isLoading || cases.length > 0) {
  <div>

    <!-- Casos encontrados -->
    @if (cases.length > 0) {
    <ion-list>
      @for (case of cases; track case.incidentid) {
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ case.title }}</ion-card-title>
          <div class="case-badges">
            <ion-chip [color]="getStatusColor(case.statuscode)">
              <ion-label>{{ getStatusText(case.statuscode) }}</ion-label>
            </ion-chip>
            <ion-chip [color]="getPriorityColor(case.prioritycode)">
              <ion-label>{{ getPriorityText(case.prioritycode) }}</ion-label>
            </ion-chip>
          </div>
        </ion-card-header>

        <ion-card-content>
          @if (case.description) {
          <p class="ion-text-wrap ion-margin-bottom" color="medium">
            {{ case.description | slice:0:120 }}{{ case.description && case.description.length > 120 ? '...' : '' }}
          </p>
          }

          <ion-item lines="none" class="ion-no-padding">
            <ion-label>
              <p><strong>Cliente:</strong> {{ case.customer_name || 'No asignado' }}</p>
              <p><strong>Creado:</strong> {{ formatDate(case.createdon) }}</p>
              @if (case.modifiedon) {
              <p><strong>Modificado:</strong> {{ formatDate(case.modifiedon) }}</p>
              }
            </ion-label>
          </ion-item>

          <!-- Botones de acción -->
          <ion-buttons class="ion-margin-top">
            <ion-button fill="clear" size="small" (click)="openViewModal(case)">
              <ion-icon name="eye-outline" slot="start"></ion-icon>
              Ver
            </ion-button>
            <ion-button fill="clear" size="small" (click)="openEditModal(case)">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              Editar
            </ion-button>
            <ion-button fill="clear" size="small" color="danger" (click)="deleteCase(case)">
              <ion-icon name="trash-outline" slot="start"></ion-icon>
              Eliminar
            </ion-button>
          </ion-buttons>
        </ion-card-content>
      </ion-card>
      }
    </ion-list>

    <!-- Infinite scroll -->
    <ion-infinite-scroll (ionInfinite)="onLoadMore($event)" [disabled]="!hasNextPage">
      <ion-infinite-scroll-content loading-text="Cargando más casos...">
      </ion-infinite-scroll-content>
    </ion-infinite-scroll>
    }

  </div>
  }

  <!-- Estado de carga inicial - Skeleton -->
  @if (isLoading && cases.length === 0) {
  <ion-list class="ion-padding">
    @for (item of [1,2,3,4,5]; track item) {
    <ion-card>
      <ion-card-header>
        <ion-skeleton-text animated style="width: 70%; height: 24px; margin-bottom: 8px;"></ion-skeleton-text>
        <div class="skeleton-badges">
          <ion-skeleton-text animated style="width: 60px; height: 20px; border-radius: 12px; margin-right: 8px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 50px; height: 20px; border-radius: 12px;"></ion-skeleton-text>
        </div>
      </ion-card-header>
      <ion-card-content>
        <div class="ion-margin-bottom">
          <ion-skeleton-text animated style="width: 100%; margin-bottom: 4px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 85%; margin-bottom: 4px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 60%; margin-bottom: 16px;"></ion-skeleton-text>
        </div>

        <div class="ion-margin-bottom">
          <ion-skeleton-text animated style="width: 40%; height: 16px; margin-bottom: 4px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 35%; height: 16px; margin-bottom: 4px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 45%; height: 16px; margin-bottom: 16px;"></ion-skeleton-text>
        </div>

        <div class="ion-margin-top" style="display: flex; gap: 8px;">
          <ion-skeleton-text animated style="width: 50px; height: 32px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 60px; height: 32px;"></ion-skeleton-text>
          <ion-skeleton-text animated style="width: 70px; height: 32px;"></ion-skeleton-text>
        </div>
      </ion-card-content>
    </ion-card>
    }
  </ion-list>
  }

  <!-- Estado vacío -->
  @if (!isLoading && cases.length === 0) {
  <div class="ion-padding ion-text-center" style="margin-top: 64px;">
    <ion-icon name="document-text-outline" size="large" color="medium"></ion-icon>
    <h3 class="ion-margin-top" style="color: var(--ion-color-medium);">No hay casos</h3>
    <p class="ion-margin-bottom" style="color: var(--ion-color-medium);">
      No se encontraron casos que coincidan con los filtros aplicados.
    </p>
    <ion-button fill="outline" (click)="clearFilters()">
      <ion-icon name="filter-outline" slot="start"></ion-icon>
      Limpiar Filtros
    </ion-button>
  </div>
  }
  </ion-grid>

  <!-- Botón flotante para agregar caso -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed">
    <ion-fab-button (click)="openCreateModal()" [disabled]="isLoading">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

</ion-content>

<!-- MODAL CREAR CASO -->
<ion-modal [isOpen]="isCreateModalOpen" (willDismiss)="closeCreateModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Crear Nuevo Caso</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeCreateModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content >
      <form [formGroup]="createForm" (ngSubmit)="createCase()">
        <ion-grid>

          <ion-row>
            <ion-col size="12">
              <ion-item>
                <ion-label position="stacked">Título del Caso *</ion-label>
                <ion-input
                  type="text"
                  formControlName="title"
                  placeholder="Ingrese el título del caso"
                  maxlength="160">
                </ion-input>
              </ion-item>
              @if (createForm.get('title')?.invalid && createForm.get('title')?.touched) {
              <ion-text color="danger">
                <div class="ion-padding-start ion-padding-top" style="font-size: 0.875rem;">
                  @if (createForm.get('title')?.errors?.['required']) {
                  <small>El título es obligatorio</small>
                  }
                  @if (createForm.get('title')?.errors?.['minlength']) {
                  <small>Mínimo 5 caracteres</small>
                  }
                </div>
              </ion-text>
              }
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12">
              <ion-item>
                <ion-label position="stacked">Descripción</ion-label>
                <ion-textarea
                  formControlName="description"
                  placeholder="Describa el problema o consulta..."
                  rows="4"
                  maxlength="2000">
                </ion-textarea>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Prioridad</ion-label>
                <ion-select formControlName="prioritycode">
                  <ion-select-option [value]="CasePriority.High">Alta</ion-select-option>
                  <ion-select-option [value]="CasePriority.Normal">Normal</ion-select-option>
                  <ion-select-option [value]="CasePriority.Low">Baja</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="6">
              <ion-item>
                <ion-label position="stacked">Origen</ion-label>
                <ion-select formControlName="caseorigincode">
                  <ion-select-option [value]="CaseOrigin.Phone">Teléfono</ion-select-option>
                  <ion-select-option [value]="CaseOrigin.Email">Email</ion-select-option>
                  <ion-select-option [value]="CaseOrigin.Web">Web</ion-select-option>
                  <ion-select-option [value]="CaseOrigin.Facebook">Facebook</ion-select-option>
                  <ion-select-option [value]="CaseOrigin.Twitter">Twitter</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" size-md="6">
              <ion-item button (click)="openAccountSearch()" detail="true">
                <ion-icon name="business-outline" slot="start" color="primary"></ion-icon>
                <ion-label>
                  <p>Cuenta Cliente</p>
                  @if (selectedAccount) {
                  <h3>{{ selectedAccount.name }}</h3>
                  } @else {
                  <h3 class="placeholder-text">Seleccionar cuenta...</h3>
                  }
                </ion-label>
                @if (selectedAccount) {
                <ion-button
                  fill="clear"
                  slot="end"
                  (click)="clearAccount($event)">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
                }
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="6">
              <ion-item button (click)="openContactSearch()" detail="true">
                <ion-icon name="person-outline" slot="start" color="secondary"></ion-icon>
                <ion-label>
                  <p>Contacto Cliente</p>
                  @if (selectedContact) {
                  <h3>{{ selectedContact.name }}</h3>
                  } @else {
                  <h3 class="placeholder-text">Seleccionar contacto...</h3>
                  }
                </ion-label>
                @if (selectedContact) {
                <ion-button
                  fill="clear"
                  slot="end"
                  (click)="clearContact($event)">
                  <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                </ion-button>
                }
              </ion-item>
            </ion-col>
          </ion-row>

          @if (selectedAccount || selectedContact) {
          <ion-row>
            <ion-col size="12">
              <ion-note color="medium" class="ion-padding-start">
                <small>
                  <ion-icon name="information-circle-outline"></ion-icon>
                  Solo se puede asociar una cuenta O un contacto, no ambos.
                </small>
              </ion-note>
            </ion-col>
          </ion-row>
          }

        </ion-grid>

        <!-- Botones del modal -->
        <div class="ion-padding" style="display: flex; justify-content: flex-end; gap: 8px;">
          <ion-button type="button" fill="outline" (click)="closeCreateModal()">
            Cancelar
          </ion-button>
          <ion-button
            type="submit"
            [disabled]="createForm.invalid">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Crear Caso
          </ion-button>
        </div>

      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- MODAL EDITAR CASO -->
<ion-modal [isOpen]="isEditModalOpen" (willDismiss)="closeEditModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Editar Caso</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeEditModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    <ion-content >
      <form [formGroup]="editForm" (ngSubmit)="updateCase()">
        <ion-grid>

          <ion-row>
            <ion-col size="12">
              <ion-item>
                <ion-label position="stacked">Título del Caso *</ion-label>
                <ion-input
                  type="text"
                  formControlName="title"
                  placeholder="Ingrese el título del caso"
                  maxlength="160">
                </ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12">
              <ion-item>
                <ion-label position="stacked">Descripción</ion-label>
                <ion-textarea
                  formControlName="description"
                  placeholder="Describa el problema o consulta..."
                  rows="4"
                  maxlength="2000">
                </ion-textarea>
              </ion-item>
            </ion-col>
          </ion-row>

          <ion-row>
            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-label position="stacked">Estado</ion-label>
                <ion-select formControlName="statuscode">
                  <ion-select-option [value]="CaseStatus.Active">Activo</ion-select-option>
                  <ion-select-option [value]="CaseStatus.Resolved">Resuelto</ion-select-option>
                  <ion-select-option [value]="CaseStatus.Canceled">Cancelado</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-label position="stacked">Prioridad</ion-label>
                <ion-select formControlName="prioritycode">
                  <ion-select-option [value]="CasePriority.High">Alta</ion-select-option>
                  <ion-select-option [value]="CasePriority.Normal">Normal</ion-select-option>
                  <ion-select-option [value]="CasePriority.Low">Baja</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-label position="stacked">Tipo de Caso</ion-label>
                <ion-input
                  type="number"
                  formControlName="casetypecode"
                  placeholder="Código numérico">
                </ion-input>
              </ion-item>
            </ion-col>
          </ion-row>

        </ion-grid>

        <!-- Botones del modal -->
        <div class="ion-padding" style="display: flex; justify-content: flex-end; gap: 8px;">
          <ion-button type="button" fill="outline" (click)="closeEditModal()">
            Cancelar
          </ion-button>
          <ion-button
            type="submit"
            [disabled]="editForm.invalid">
            <ion-icon name="save-outline" slot="start"></ion-icon>
            Actualizar Caso
          </ion-button>
        </div>

      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- MODAL VER CASO -->
<ion-modal [isOpen]="isViewModalOpen" (willDismiss)="closeViewModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>Detalles del Caso</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeViewModal()">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>

    @if (selectedCase) {
    <ion-content >
      <ion-card>
        <ion-card-header>
          <ion-card-title>{{ selectedCase.title }}</ion-card-title>
          <div class="case-badges">
            <ion-chip [color]="getStatusColor(selectedCase.statuscode)">
              <ion-label>{{ getStatusText(selectedCase.statuscode) }}</ion-label>
            </ion-chip>
            <ion-chip [color]="getPriorityColor(selectedCase.prioritycode)">
              <ion-label>{{ getPriorityText(selectedCase.prioritycode) }}</ion-label>
            </ion-chip>
          </div>
        </ion-card-header>

        <ion-card-content>
          <ion-list>
            <ion-item>
              <ion-label>
                <h3>ID del Caso</h3>
                <p>{{ selectedCase.incidentid }}</p>
              </ion-label>
            </ion-item>

            @if (selectedCase.description) {
            <ion-item>
              <ion-label>
                <h3>Descripción</h3>
                <p>{{ selectedCase.description }}</p>
              </ion-label>
            </ion-item>
            }

            @if (selectedCase.customer_name) {
            <ion-item>
              <ion-label>
                <h3>Cliente</h3>
                <p>{{ selectedCase.customer_name }}</p>
              </ion-label>
            </ion-item>
            }

            @if (selectedCase.customerid) {
            <ion-item>
              <ion-label>
                <h3>ID Cliente</h3>
                <p>{{ selectedCase.customerid }}</p>
              </ion-label>
            </ion-item>
            }

            <ion-item>
              <ion-label>
                <h3>Fechas</h3>
                <p><strong>Creado:</strong> {{ formatDate(selectedCase.createdon) }}</p>
                @if (selectedCase.modifiedon) {
                <p><strong>Modificado:</strong> {{ formatDate(selectedCase.modifiedon) }}</p>
                }
              </ion-label>
            </ion-item>

            @if (selectedCase.casetypecode) {
            <ion-item>
              <ion-label>
                <h3>Tipo de Caso</h3>
                <p>{{ selectedCase.casetypecode }}</p>
              </ion-label>
            </ion-item>
            }

            @if (selectedCase.caseorigincode) {
            <ion-item>
              <ion-label>
                <h3>Origen</h3>
                <p>{{ selectedCase.caseorigincode }}</p>
              </ion-label>
            </ion-item>
            }

            @if (selectedCase.escalated !== undefined) {
            <ion-item>
              <ion-label>
                <h3>Escalado</h3>
                <p>{{ selectedCase.escalated ? 'Sí' : 'No' }}</p>
              </ion-label>
            </ion-item>
            }
          </ion-list>
        </ion-card-content>
      </ion-card>
    </ion-content>
    }
  </ng-template>
</ion-modal>

<!-- COMPONENTES DE BÚSQUEDA -->
<app-crm-search
  entityType="account"
  [isOpen]="isAccountSearchOpen"
  (itemSelected)="onAccountSelected($event)"
  (modalClosed)="closeAccountSearch()">
</app-crm-search>

<app-crm-search
  entityType="contact"
  [isOpen]="isContactSearchOpen"
  (itemSelected)="onContactSelected($event)"
  (modalClosed)="closeContactSearch()">
</app-crm-search>
