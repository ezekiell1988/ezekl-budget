<app-header
  title="Sistema CRM"
  [showMenu]="true"
  [showActions]="false">
</app-header>

<ion-content>
  <!-- Pull to refresh -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)">
    <ion-refresher-content
      pulling-text="Desliza para actualizar"
      refreshing-text="Actualizando información...">
    </ion-refresher-content>
  </ion-refresher>

  <ion-grid fixed>

    <!-- =============================================== -->
    <!-- HEALTH CHECK -->
    <!-- =============================================== -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="heart-outline" style="vertical-align: middle; margin-right: 8px;"></ion-icon>
          Health Check
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        @if (isLoading && !healthData) {
          <!-- Skeleton loading -->
          <ion-item lines="none">
            <ion-label>
              <ion-skeleton-text [animated]="true" style="width: 40%;"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="width: 60%;"></ion-skeleton-text>
            </ion-label>
          </ion-item>
        }

        @if (!isLoading && healthError) {
          <!-- Error state -->
          <ion-item lines="none" color="danger">
            <ion-icon name="close-circle" slot="start"></ion-icon>
            <ion-label>
              <p>{{ healthError }}</p>
            </ion-label>
          </ion-item>
        }

        @if (!isLoading && healthData) {
          <!-- Success state -->
          <ion-item lines="none">
            <ion-label>
              <h3>Estado del Servicio</h3>
              <p>
                <ion-chip [color]="getStatusColor(healthData.status)">
                  <ion-icon [name]="getStatusIcon(healthData.status)"></ion-icon>
                  <ion-label>{{ healthData.status.toUpperCase() }}</ion-label>
                </ion-chip>
              </p>
            </ion-label>
          </ion-item>

          <ion-item lines="none">
            <ion-icon name="server-outline" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>Dynamics 365</h3>
              <p class="ion-text-wrap">{{ healthData.d365 }}</p>
            </ion-label>
          </ion-item>

          <ion-item lines="none">
            <ion-icon name="cloud-outline" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>Versión API</h3>
              <p>{{ healthData.api_version }}</p>
            </ion-label>
          </ion-item>
        }
      </ion-card-content>
    </ion-card>

    <!-- =============================================== -->
    <!-- TOKEN INFO -->
    <!-- =============================================== -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="key-outline" style="vertical-align: middle; margin-right: 8px;"></ion-icon>
          Información del Token
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        @if (isLoading && !tokenData) {
          <!-- Skeleton loading -->
          <ion-item lines="none">
            <ion-label>
              <ion-skeleton-text [animated]="true" style="width: 40%;"></ion-skeleton-text>
              <ion-skeleton-text [animated]="true" style="width: 80%;"></ion-skeleton-text>
            </ion-label>
          </ion-item>
        }

        @if (!isLoading && tokenError) {
          <!-- Error state -->
          <ion-item lines="none" color="danger">
            <ion-icon name="close-circle" slot="start"></ion-icon>
            <ion-label>
              <p>{{ tokenError }}</p>
            </ion-label>
          </ion-item>
        }

        @if (!isLoading && tokenData) {
          <!-- Success state -->
          <ion-item lines="none">
            <ion-label>
              <h3>Token (Vista Previa)</h3>
              <p class="ion-text-wrap" style="font-family: monospace; font-size: 0.9em;">
                {{ tokenData.token_preview }}
              </p>
            </ion-label>
          </ion-item>

          <ion-item lines="none">
            <ion-icon name="time-outline" slot="start" color="primary"></ion-icon>
            <ion-label>
              <h3>Expira</h3>
              <p>{{ formatTimestamp(tokenData.expires_at) }}</p>
            </ion-label>
          </ion-item>

          <ion-item lines="none">
            <ion-button
              expand="block"
              fill="outline"
              (click)="clearCache()"
              [disabled]="isLoading">
              <ion-icon name="refresh-outline" slot="start"></ion-icon>
              Limpiar Caché de Token
            </ion-button>
          </ion-item>
        }
      </ion-card-content>
    </ion-card>

    <!-- =============================================== -->
    <!-- DIAGNÓSTICO -->
    <!-- =============================================== -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>
          <ion-icon name="bug-outline" style="vertical-align: middle; margin-right: 8px;"></ion-icon>
          Diagnóstico Completo
        </ion-card-title>
      </ion-card-header>

      <ion-card-content>
        @if (isLoading && !diagnoseData) {
          <!-- Skeleton loading -->
          @for (item of [1,2,3]; track item) {
            <ion-item lines="none">
              <ion-label>
                <ion-skeleton-text [animated]="true" style="width: 50%;"></ion-skeleton-text>
                <ion-skeleton-text [animated]="true" style="width: 70%;"></ion-skeleton-text>
              </ion-label>
            </ion-item>
          }
        }

        @if (!isLoading && diagnoseError) {
          <!-- Error state -->
          <ion-item lines="none" color="danger">
            <ion-icon name="close-circle" slot="start"></ion-icon>
            <ion-label>
              <p>{{ diagnoseError }}</p>
            </ion-label>
          </ion-item>
        }

        @if (!isLoading && diagnoseData) {
          <!-- Variables de Entorno -->
          <ion-item lines="none" class="section-header">
            <ion-label>
              <h3><strong>Variables de Entorno</strong></h3>
            </ion-label>
          </ion-item>

          @for (entry of getObjectEntries(diagnoseData.environment_variables); track entry[0]) {
            <ion-item lines="none">
              <ion-label>
                <p><strong>{{ entry[0] }}</strong></p>
                <p>
                  <ion-chip [color]="getStatusColor(entry[1])">
                    <ion-label>{{ entry[1] }}</ion-label>
                  </ion-chip>
                </p>
              </ion-label>
            </ion-item>
          }

          <!-- Token Acquisition -->
          <ion-item lines="none" class="section-header ion-margin-top">
            <ion-label>
              <h3><strong>Adquisición de Token</strong></h3>
            </ion-label>
          </ion-item>

          @for (entry of getObjectEntries(diagnoseData.token_acquisition); track entry[0]) {
            <ion-item lines="none">
              <ion-label>
                <p><strong>{{ entry[0] }}</strong></p>
                <p class="ion-text-wrap">
                  @if (entry[0] === 'status') {
                    <ion-chip [color]="getStatusColor(entry[1])">
                      <ion-label>{{ entry[1] }}</ion-label>
                    </ion-chip>
                  } @else {
                    {{ entry[1] }}
                  }
                </p>
              </ion-label>
            </ion-item>
          }

          <!-- Conectividad D365 -->
          <ion-item lines="none" class="section-header ion-margin-top">
            <ion-label>
              <h3><strong>Conectividad Dynamics 365</strong></h3>
            </ion-label>
          </ion-item>

          @for (entry of getObjectEntries(diagnoseData.d365_connectivity); track entry[0]) {
            <ion-item lines="none">
              <ion-label>
                <p><strong>{{ entry[0] }}</strong></p>
                <p class="ion-text-wrap">
                  @if (entry[0] === 'status') {
                    <ion-chip [color]="getStatusColor(entry[1])">
                      <ion-label>{{ entry[1] }}</ion-label>
                    </ion-chip>
                  } @else {
                    {{ entry[1] }}
                  }
                </p>
              </ion-label>
            </ion-item>
          }

          <!-- Recomendaciones -->
          @if (diagnoseData.recommendations && diagnoseData.recommendations.length > 0) {
            <ion-item lines="none" class="section-header ion-margin-top">
              <ion-label>
                <h3><strong>Recomendaciones</strong></h3>
              </ion-label>
            </ion-item>

            @for (recommendation of diagnoseData.recommendations; track recommendation; let idx = $index) {
              <ion-item lines="none">
                <ion-icon name="warning-outline" slot="start" color="warning"></ion-icon>
                <ion-label class="ion-text-wrap">
                  <p>{{ recommendation }}</p>
                </ion-label>
              </ion-item>
            }
          }

          @if (!diagnoseData.recommendations || diagnoseData.recommendations.length === 0) {
            <ion-item lines="none" class="ion-margin-top">
              <ion-icon name="checkmark-circle" slot="start" color="success"></ion-icon>
              <ion-label>
                <p>✅ Todo configurado correctamente. No hay recomendaciones.</p>
              </ion-label>
            </ion-item>
          }
        }
      </ion-card-content>
    </ion-card>

  </ion-grid>
</ion-content>
