<ion-content [fullscreen]="true" class="ion-padding">
  <div class="login-container">
    <ion-grid fixed>
      <ion-row class="ion-justify-content-center">
        <ion-col size="12" size-md="6" size-lg="4">

        <!-- Logo y bienvenida usando ion-text y ion-note -->
        <div class="ion-text-center ion-margin-bottom">
          <ion-icon name="wallet" color="primary" size="large" style="font-size: 4rem;"></ion-icon>
          <ion-text color="primary">
            <h1>Ezekl Budget</h1>
          </ion-text>
          <ion-note color="medium">
            <p>Gestión inteligente de presupuesto</p>
          </ion-note>
        </div>

        <!-- Wizard Step 1: Solicitar código de usuario -->
        @if ((wizardState$ | async)?.currentStep === loginSteps.REQUEST_TOKEN) {
        <ion-card class="ion-margin">
          <ion-card-header>
            <ion-card-title color="primary">
              <ion-icon name="person-circle" slot="start"></ion-icon>
              Identificación
            </ion-card-title>
            <ion-card-subtitle>
              Ingresa tu código de usuario para comenzar
            </ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <form [formGroup]="step1Form" (ngSubmit)="requestToken()">

              <ion-item fill="outline" class="ion-margin-bottom">
                <ion-label position="stacked">Código de Usuario</ion-label>
                <ion-input formControlName="codeLogin" placeholder="Ej: ABC123" maxlength="10" [clearInput]="true">
                </ion-input>
              </ion-item>

              <!-- Mensaje de error -->
              @if ((wizardState$ | async)?.error) {
              <ion-note color="danger" class="ion-margin-top">
                <ion-icon name="alert-circle"></ion-icon>
                {{ (wizardState$ | async)?.error }}
              </ion-note>
              }

              <!-- Botón continuar -->
              <ion-button expand="full" type="submit" shape="round" size="large"
                [disabled]="step1Form.invalid || (wizardState$ | async)?.isLoading" class="ion-margin-top">
                @if ((wizardState$ | async)?.isLoading) {
                <ion-spinner name="crescent" slot="start"></ion-spinner>
                <span>Enviando...</span>
                } @else {
                <span>Continuar</span>
                }
              </ion-button>
            </form>
          </ion-card-content>
        </ion-card>
        }

        <!-- Wizard Step 2: Ingresar token -->
        @if ((wizardState$ | async)?.currentStep === loginSteps.ENTER_TOKEN) {
        <ion-card class="ion-margin">
          <ion-card-header>
            <ion-card-title color="primary">
              <ion-icon name="mail" slot="start"></ion-icon>
              Verificación
            </ion-card-title>
            <ion-card-subtitle>
              Ingresa el código de 5 dígitos enviado a tu email
            </ion-card-subtitle>
          </ion-card-header>

          <ion-card-content>
            <!-- Información del usuario -->
            @if ((wizardState$ | async)?.user; as user) {
            <div class="ion-text-center ion-margin-bottom">
              <ion-chip color="primary" outline="true">
                <ion-avatar>
                  <ion-icon name="person"></ion-icon>
                </ion-avatar>
                <ion-label>{{ user.nameLogin }}</ion-label>
              </ion-chip>
              <br>
              <ion-note color="medium">{{ user.emailLogin }}</ion-note>
            </div>
            }

            <form [formGroup]="step2Form" (ngSubmit)="login()">

              <!-- Token inputs usando ion-grid -->
              <div class="ion-margin-bottom ion-text-center">
                <ion-text color="primary">
                  <h3>Código de verificación:</h3>
                </ion-text>
              </div>

              <ion-grid>
                <ion-row class="ion-justify-content-center">
                  @for (control of tokenControls; track $index; let i = $index) {
                  <ion-col size="2">
                    <ion-item fill="outline" lines="none">
                      <ion-input #tokenInput [formControlName]="'digit' + (i + 1)" type="tel" inputmode="numeric"
                        maxlength="1" [class.ion-valid]="tokenControls[i].valid && tokenControls[i].value"
                        (ionInput)="onTokenDigitInput(i, $event, tokenInput)" (keydown)="onTokenKeydown(i, $event)"
                        (ionFocus)="onTokenInputClick(i)" autocomplete="off"
                        style="text-align: center; font-size: 1.5rem; font-weight: bold;" placeholder="0">
                      </ion-input>
                    </ion-item>
                  </ion-col>
                  }
                </ion-row>
              </ion-grid>

              <!-- Auto-copy button -->
              <ion-button fill="clear" expand="block" (click)="tryAutoCopy()"
                [disabled]="(wizardState$ | async)?.isLoading" class="ion-margin-vertical" color="medium">
                <ion-icon name="clipboard" slot="start"></ion-icon>
                Pegar desde portapapeles
              </ion-button>

              <!-- Mensaje de error -->
              @if ((wizardState$ | async)?.error) {
              <ion-note color="danger" class="ion-margin-top">
                <ion-icon name="alert-circle"></ion-icon>
                {{ (wizardState$ | async)?.error }}
              </ion-note>
              }

              <!-- Botones de acción usando ion-grid -->
              <ion-grid>
                <ion-row>
                  <ion-col size="6">
                    <ion-button fill="outline" expand="block" (click)="goBack()"
                      [disabled]="(wizardState$ | async)?.isLoading">
                      <ion-icon name="arrow-back" slot="start"></ion-icon>
                      Atrás
                    </ion-button>
                  </ion-col>
                  <ion-col size="6">
                    <ion-button fill="outline" color="warning" expand="block" (click)="resendToken()"
                      [disabled]="(wizardState$ | async)?.isLoading">
                      <ion-icon name="refresh" slot="start"></ion-icon>
                      Reenviar
                    </ion-button>
                  </ion-col>
                </ion-row>
                <ion-row>
                  <ion-col size="12">
                    <ion-button expand="full" type="submit" shape="round" size="large"
                      [disabled]="step2Form.invalid || (wizardState$ | async)?.isLoading" class="ion-margin-top">
                      @if ((wizardState$ | async)?.isLoading) {
                      <ion-spinner name="crescent" slot="start"></ion-spinner>
                      <span>Validando...</span>
                      } @else {
                      <span>Iniciar Sesión</span>
                      }
                    </ion-button>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </form>
          </ion-card-content>
        </ion-card>
        }

        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
</ion-content>
